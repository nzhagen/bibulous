
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>bibulous &#8212; Bibulous 1.3.2 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../index.html"><img src="../_static/banner.svg" border="0" height=300 alt="py4sci"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo_small.svg" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bibulous</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># pylint: disable-msg=C0321</span>
<span class="c1"># pylint: max-line-length=120</span>
<span class="c1"># pylint: max-module-lines=10000</span>
<span class="c1"># See the LICENSE.rst file for licensing information.</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">locale</span>       <span class="c1">## for language internationalization and localization</span>
<span class="kn">import</span> <span class="nn">getopt</span>       <span class="c1">## for getting command-line options</span>
<span class="kn">import</span> <span class="nn">copy</span>         <span class="c1">## for the &quot;deepcopy&quot; command</span>
<span class="kn">import</span> <span class="nn">platform</span>     <span class="c1">## for determining the OS of the system</span>
<span class="kn">import</span> <span class="nn">pdb</span>          <span class="c1">## put &quot;pdb.set_trace()&quot; at any place you want to interact with pdb</span>
<span class="c1">#import traceback    ## for getting full traceback info in exceptions</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Bibulous is a drop-in replacement for BibTeX, with the primary advantage that the bibliography</span>
<span class="sd">template format is compact and *very* easy to modify.</span>

<span class="sd">The basic program flow upon object initialization is as follows:</span>

<span class="sd">1. Read the `.aux` file and get the names of the bibliography databases (`.bib` files),</span>
<span class="sd">   the style templates (`.bst` files) to use, and the entire set of citations.</span>
<span class="sd">2. Read in the Bibulous style template `.bst` file as a dictionary (`bstdict`). This also</span>
<span class="sd">   allows us to set options for how to parse the database file(s).</span>
<span class="sd">3. Look for the `-extract.bib` &quot;extracted&quot; database file. If it exists, then read it in.</span>
<span class="sd">   Compare the entrykeys in the the extracted database to the citation keys in the `.aux`</span>
<span class="sd">   file. If any of the latter are not within the extracted database, then re-extract the</span>
<span class="sd">   database from the main database file. Otherwise, continue with the extracted database.</span>
<span class="sd">4. If the extracted database doesn&#39;t exist, or need to be replaced, then read in all of</span>
<span class="sd">   the bibliography database files into one long dictionary (`bibdata`), replacing any</span>
<span class="sd">   abbreviations with their full form. Cross-referenced data is *not* yet inserted at</span>
<span class="sd">   this point. That is delayed until the time of writing the BBL file in order to speed up</span>
<span class="sd">   parsing.</span>
<span class="sd">5. Now that all the information is collected, go through each citation key, find the</span>
<span class="sd">   corresponding entry key in `bibdata`. From the entry type, select a template from `bstdict`</span>
<span class="sd">   and begin inserting the variables one-by-one into the template. If any data is missing,</span>
<span class="sd">   check for cross-references and use crossref data to fill in missing values.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1">#def info(type, value, tb):</span>
<span class="c1">#   #if (not sys.stderr.isatty() or</span>
<span class="c1">#   #    not sys.stdin.isatty()):</span>
<span class="c1">#   #    ## stdin or stderr is redirected, just do the normal thing</span>
<span class="c1">#   #    original_hook(type, value, tb)</span>
<span class="c1">#   #else:</span>
<span class="c1">#   if True:</span>
<span class="c1">#       ## a terminal is attached and stderr is not redirected, debug</span>
<span class="c1">#       traceback.print_exception(type, value, tb)</span>
<span class="c1">#       print(&#39;&#39;)</span>
<span class="c1">#       pdb.pm()</span>
<span class="c1">#       #traceback.print_stack()</span>
<span class="c1">#sys.excepthook = info      ## go into debugger automatically on an exception</span>

<span class="n">__authors__</span> <span class="o">=</span> <span class="s1">&#39;Nathan Hagen&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s1">&#39;MIT/X11 License&#39;</span>
<span class="n">__contact__</span> <span class="o">=</span> <span class="s1">&#39;Nathan Hagen &lt;and.the.light.shattered@gmail.com&gt;&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.3&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sentence_case&#39;</span><span class="p">,</span> <span class="s1">&#39;stringsplit&#39;</span><span class="p">,</span> <span class="s1">&#39;namefield_to_namelist&#39;</span><span class="p">,</span> <span class="s1">&#39;namestr_to_namedict&#39;</span><span class="p">,</span>
           <span class="s1">&#39;initialize_name&#39;</span><span class="p">,</span> <span class="s1">&#39;get_delim_levels&#39;</span><span class="p">,</span> <span class="s1">&#39;show_levels_debug&#39;</span><span class="p">,</span> <span class="s1">&#39;get_quote_levels&#39;</span><span class="p">,</span> <span class="s1">&#39;splitat&#39;</span><span class="p">,</span> <span class="s1">&#39;multisplit&#39;</span><span class="p">,</span>
           <span class="s1">&#39;enwrap_nested_string&#39;</span><span class="p">,</span> <span class="s1">&#39;enwrap_nested_quotes&#39;</span><span class="p">,</span> <span class="s1">&#39;purify_string&#39;</span><span class="p">,</span> <span class="s1">&#39;latex_to_utf8&#39;</span><span class="p">,</span>
           <span class="s1">&#39;search_middlename_for_prefixes&#39;</span><span class="p">,</span> <span class="s1">&#39;get_edition_ordinal&#39;</span><span class="p">,</span> <span class="s1">&#39;export_bibfile&#39;</span><span class="p">,</span> <span class="s1">&#39;parse_pagerange&#39;</span><span class="p">,</span>
           <span class="s1">&#39;parse_nameabbrev&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_script&#39;</span><span class="p">,</span> <span class="s1">&#39;str_is_integer&#39;</span><span class="p">,</span> <span class="s1">&#39;bib_warning&#39;</span><span class="p">,</span> <span class="s1">&#39;create_citation_alpha&#39;</span><span class="p">,</span>
           <span class="s1">&#39;toplevel_split&#39;</span><span class="p">,</span> <span class="s1">&#39;get_variable_name_elements&#39;</span><span class="p">,</span> <span class="s1">&#39;format_namelist&#39;</span><span class="p">,</span>
           <span class="s1">&#39;namedict_to_formatted_namestr&#39;</span><span class="p">,</span> <span class="s1">&#39;argsort&#39;</span><span class="p">,</span> <span class="s1">&#39;create_alphanum_citelabels&#39;</span><span class="p">,</span><span class="s1">&#39;get_implicit_loop_data&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Bibdata"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata">[docs]</a><span class="k">class</span> <span class="nc">Bibdata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bibdata is a class to hold all data related to a bibliography database, a citation list, and a style template.</span>

<span class="sd">    To initialize the class, either call it with the filename of the `.aux` file containing the relevant file locations</span>
<span class="sd">    (for the `.bib` database files and the `.bst` template files) or simply call it with a list of all filenames to be</span>
<span class="sd">    used (i.e. `database_name.bib`, `style_template_name.bst` and `main_filename.aux`). The output file (the LaTeX-</span>
<span class="sd">    formatted bibliography) is assumed to have the same filename root as the `.aux` file, but with `.bbl` as its</span>
<span class="sd">    extension.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    abbrevs : dict</span>
<span class="sd">        The list of abbreviations given in the bibliography database file(s). The dictionary keys are the \</span>
<span class="sd">        abbreviations, and the values are their full forms.</span>
<span class="sd">    bibdata : dict</span>
<span class="sd">        The database of bibliography entries and fields derived from parsing the bibliography database file(s).</span>
<span class="sd">    bstdict : dict</span>
<span class="sd">        The style template for formatting the bibliography. The dictionary keys are the entrytypes, with the dictionary</span>
<span class="sd">        values their string template.</span>
<span class="sd">    citedict : dict</span>
<span class="sd">        The dictionary of citation keys, and their corresponding numerical order of citation.</span>
<span class="sd">    debug : bool</span>
<span class="sd">        Whether to turn on debugging features.</span>
<span class="sd">    filedict : dict</span>
<span class="sd">        The ditionary of filenames associated with the bibliographic data. The dictionary consists of keys `bib`, \</span>
<span class="sd">        `bst`, `aux`, `tex`, and `bbl`. The first two are lists of filenames, while the others contain only a single \</span>
<span class="sd">        filename.</span>
<span class="sd">    filename : str</span>
<span class="sd">        (For error messages and debugging) The name of the file currently being parsed.</span>
<span class="sd">    i : int</span>
<span class="sd">        (For error messages and debugging) The line of the file currently being parsed.</span>
<span class="sd">    options : dict</span>
<span class="sd">        The dictionary containing the various option settings from the style template (BST) files.</span>
<span class="sd">    specials : dict</span>
<span class="sd">        The dictionary containing the special templates from the BST file(s).</span>
<span class="sd">    abbrevkey_pattern : compiled regular expression object</span>
<span class="sd">        The regex used to search for abbreviation keys.</span>
<span class="sd">    anybrace_pattern : compiled regular expression object</span>
<span class="sd">        The regex used to search for curly braces `{` or `}`.</span>
<span class="sd">    anybraceorquote_pattern : compiled regular expression object</span>
<span class="sd">        The regex used to search for curly braces or for double-quotes, i.e. `{`, `}`, or `&quot;`.</span>
<span class="sd">    endbrace_pattern : compiled regular expression object</span>
<span class="sd">        The regex used to search for an ending curly brace, i.e. &#39;}&#39;.</span>
<span class="sd">    quote_pattern : compiled regular expression object</span>
<span class="sd">        The regex used to search for a double-quote, i.e. `&quot;`.</span>
<span class="sd">    startbrace_pattern : compiled regular expression object</span>
<span class="sd">        The regex used to search for a starting curly brace, `{`.</span>
<span class="sd">    culldata : bool</span>
<span class="sd">        Whether to cull the database so that only cited entries are parsed. Setting this to False means that the entire \</span>
<span class="sd">        BIB file database will be parsed. When True, the BIB file parser will only parse those entries corresponding to \</span>
<span class="sd">        keys in the citedict. Setting this to True provides significant speedups for large databases.</span>
<span class="sd">    parse_only_entrykeys : bool</span>
<span class="sd">        When comparing a database file against a citation list, all we are initially interested in are the entrykeys \</span>
<span class="sd">        and not the data. So, in our first pass through the database, we can use this flag to skip the data and get \</span>
<span class="sd">        only the keys themselves.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    parse_bibfile</span>
<span class="sd">    parse_bibentry</span>
<span class="sd">    parse_bibfield</span>
<span class="sd">    parse_auxfile</span>
<span class="sd">    parse_bstfile</span>
<span class="sd">    write_bblfile</span>
<span class="sd">    create_citation_list</span>
<span class="sd">    format_bibitem</span>
<span class="sd">    insert_crossref_data</span>
<span class="sd">    write_citeextract</span>
<span class="sd">    write_authorextract</span>
<span class="sd">    replace_abbrevs_with_full</span>
<span class="sd">    get_bibfilenames</span>
<span class="sd">    check_citekeys_in_datakeys</span>
<span class="sd">    add_crossrefs_to_searchkeys</span>
<span class="sd">    insert_specials</span>
<span class="sd">    validate_templatestr</span>
<span class="sd">    fillout_implicit_indices</span>
<span class="sd">    template_substitution</span>
<span class="sd">    insert_title_into_template</span>
<span class="sd">    remove_nested_template_options_brackets</span>
<span class="sd">    remove_template_options_brackets</span>
<span class="sd">    simplify_template_bracket</span>
<span class="sd">    get_variable</span>
<span class="sd">    format_operator_arg</span>
<span class="sd">    get_indexed_variable</span>
<span class="sd">    get_indexed_vars_in_template</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    bibdata = Bibdata(&#39;jobname.aux&#39;)</span>
<span class="sd">    bibdata.write_bblfile()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">culldata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">uselocale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jan&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;feb&#39;</span><span class="p">:</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;mar&#39;</span><span class="p">:</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;apr&#39;</span><span class="p">:</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;may&#39;</span><span class="p">:</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;jun&#39;</span><span class="p">:</span><span class="s1">&#39;6&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;jul&#39;</span><span class="p">:</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;aug&#39;</span><span class="p">:</span><span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;sep&#39;</span><span class="p">:</span><span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;oct&#39;</span><span class="p">:</span><span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;nov&#39;</span><span class="p">:</span><span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">:</span><span class="s1">&#39;12&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;preamble&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c1">## the dictionary containing all of the files associated with the bibliography</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c1">## the dictionary containing the original data from the AUX file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1">## the list of citation keys, given in the order determined by &quot;self.sortlist&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1">## the (sorted) list of sorting keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span> <span class="o">=</span> <span class="p">{}</span>           <span class="c1">## the dictionary containing all information from template files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_script</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>       <span class="c1">## any user-written Python scripts go here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_variables</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">## any user-defined variables from the BST files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span> <span class="o">=</span> <span class="n">culldata</span>    <span class="c1">## whether to cull the database so that only cited entries are parsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span> <span class="o">=</span> <span class="p">[]</span>        <span class="c1">## when culling data, this is the list of keys to limit parsing to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_only_entrykeys</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">## don&#39;t parse the data in the database; get only entrykeys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">## which templates have nested option blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">looped_templates</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1">## which templates have implicit loops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implicitly_indexed_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;authorname&#39;</span><span class="p">,</span><span class="s1">&#39;editorname&#39;</span><span class="p">]</span> <span class="c1">## which templates have implicit indexing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implicit_loop_pairs</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">## the dictionary pairing name variable with namelist (i.e. &quot;authorname&quot; with &quot;authorlist&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1">## dict containing all variables calling the &quot;uniquify&quot; operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1">## &quot;keylist&quot; is a temporary holding place for the citations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxfile_list</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1">## a list of *.aux files, for use when citations are inside nested files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelists</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1">## the list of all &quot;namelist&quot; type variables</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">uselocale</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>    <span class="c1">## set the locale to the user&#39;s default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span><span class="n">uselocale</span><span class="p">)</span>    <span class="c1">## set the locale as requested</span>

        <span class="c1">## Not only do we need a dictionary for &quot;special templates&quot; but we also need to be able to iterate through it</span>
        <span class="c1">## in the order given in the file. Thus, we have a &quot;specials list&quot; too.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">## Put in the default special templates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;authorlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;author.to_namelist()&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;editorlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;editor.to_namelist()&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;citelabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;citenum&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;sortkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;citenum&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;au&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;authorlist.format_authorlist()&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;editorlist.format_editorlist()&gt;&#39;</span>

        <span class="c1">## Temporary variables for use in error messages while parsing files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                      <span class="c1">## the current filename (for error messages)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>                              <span class="c1">## counter for line in file (for error messages)</span>

        <span class="c1">## On default initialization, we don&#39;t want to issue any warnings about &quot;overwriting&quot; the default options. So</span>
        <span class="c1">## if no &quot;default&quot; keyword is given, then turn off warning #9.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">disable</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">disable</span>              <span class="c1">## the list of warning message numbers to disable</span>

        <span class="c1">## Put in default options settings.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_abbrevs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;???&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;procspie_as_journal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;backrefstyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;backrefs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;sort_case&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bibitemsep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;allow_scripts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;case_sensitive_field_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_citeextract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;etal_message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, </span><span class="se">\\</span><span class="s1">textit{et al.}&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;edmsg1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, ed.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;edmsg2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, eds&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;replace_newlines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;sort_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Forward&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wrap_nested_quotes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;autocomplete_doi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;and&#39;</span>

        <span class="c1">## These options all relate to the default name formatting (the more rigid namelist formatting that does not use</span>
        <span class="c1">## the implicit indexing and implicit loop structures).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_firstname_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;namelist_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first_name_first&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;minauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxeditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mineditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_name_ties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;terse_inits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">## Compile some patterns for use in regex searches. Note that &quot;[\-\+\*\#\$\w]&quot; matches any alphanumeric character plus any of [~@%&amp;-+*#$^?!=:]</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[~@%&amp;\-\+\*\#\$\^\?\!\=\:\w]+?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anybrace_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startbrace_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">){&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endbrace_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbrevkey_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)[,#]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anybraceorquote_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)[</span><span class="si">{}</span><span class="s1">&quot;]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integer_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-?[0-9]+&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\.\d+\.&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&gt;)|(&lt;&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\.\d+&gt;)|(&lt;&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\.(nN)\.&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&gt;)|(&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\.(nN)&gt;)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implicit_index_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\.n\.&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;&gt;)|(&lt;&#39;</span><span class="o">+</span><span class="n">pat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\.n&gt;)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_variable_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;)\.+?(?=&gt;)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_variable_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;)\.+?(?=.to_namelist\(\)&gt;)&#39;</span><span class="p">)</span>

        <span class="c1">## Create an inverse dictionary for the month names --- one version will full names, and one with abbreviated</span>
        <span class="c1">## names. For a Unix-based system, the month names are determined by the user&#39;s default locale. How to do this</span>
        <span class="c1">## for a MS Windows system?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthnames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthabbrevs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">):</span>
                <span class="c1">## The abbreviated form (i.e. &#39;Jan&#39;).</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthabbrevs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">nl_langinfo</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ABMON_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthabbrevs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span><span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span><span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span><span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span><span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span><span class="s1">&#39;Jun&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;7&#39;</span><span class="p">:</span><span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span><span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span><span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">:</span><span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;11&#39;</span><span class="p">:</span><span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span><span class="p">:</span><span class="s1">&#39;Dec&#39;</span><span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthnames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span><span class="s1">&#39;February&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span><span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span><span class="s1">&#39;April&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;5&#39;</span><span class="p">:</span><span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span><span class="s1">&#39;June&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span><span class="s1">&#39;July&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span><span class="s1">&#39;August&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span><span class="s1">&#39;September&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;10&#39;</span><span class="p">:</span><span class="s1">&#39;October&#39;</span><span class="p">,</span> <span class="s1">&#39;11&#39;</span><span class="p">:</span><span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span><span class="p">:</span><span class="s1">&#39;December&#39;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## The full form (i.e. &#39;January&#39;).</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthnames</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">nl_langinfo</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;MON_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="c1">## Get the list of filenames associated with the bibliography (AUX, BBL, BIB, TEX). Additionally, if the input</span>
        <span class="c1">## &quot;filename&quot; contains only the AUX file, then we assume that the user wants only to parse that part if the</span>
        <span class="c1">## database corresponding to the citation keys in the AUX file. This default behavior can be overriden (so that</span>
        <span class="c1">## the entire database is parsed) is the optional keyword &quot;cull_database&quot; is set to False.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_bibfilenames</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1">## Print out some info on Bibulous and the files it is working on.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is Bibulous, version &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">__version__</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The current working directory is: &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The top-level TeX file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;tex&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The top-level auxiliary file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;aux&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The bibliography database file(s): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bib&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The Bibulous style template file(s): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bst&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The output formatted bibliography file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bbl&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;aux&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_auxfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;aux&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">## Parsing the style file has to go *before* parsing the BIB file, so that any style options that affect the way</span>
        <span class="c1">## the data is parsed can take effect.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bst&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bst&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bstfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1">## Now that we&#39;ve parsed the BST file, we need to check the list of special templates. For the &quot;authorlist&quot; and</span>
        <span class="c1">## &quot;editorlist&quot;, the ordering matters! It may seem that this section is easily replaced with a simple list, but</span>
        <span class="c1">## the structure here is needed in order to keep the order of items correct.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;authorlist&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;authorlist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;editorlist&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;editorlist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;citelabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;citelabel&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;sortkey&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sortkey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;au&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span>

        <span class="c1">## Next, get the list of entrykeys in the database file(s), and compare them against the list of citation keys.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bib&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_citeextract&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;extract&#39;</span><span class="p">]):</span>
                <span class="c1">## Check if the extract file is complete by reading in the database keys and checking against the</span>
                <span class="c1">## citation list.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_only_entrykeys</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;extract&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_only_entrykeys</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_complete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_citekeys_in_datakeys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">is_complete</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">## Clear the bibliography database, or we will get &quot;overwrite&quot; errors when we parse it again below</span>
                <span class="c1">## (since right now all we have are entrykeys).</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;preamble&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_complete</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1">## If the current database is complete, then just go ahead and use it. If not, then parse the main database</span>
            <span class="c1">## file(s).</span>
            <span class="k">if</span> <span class="n">is_complete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;extract&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bib&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_crossrefs_to_searchkeys</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;preamble&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;preamble&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">):</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="s1">&#39;preamble&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">):</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
                <span class="c1">## Write out the extracted database.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_citeextract&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_citeextract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;extract&#39;</span><span class="p">])</span>

        <span class="k">return</span>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.parse_bibfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bibfile">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bibfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parse a &quot;.bib&quot; file to generate a dictionary representing a bibliography database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the .bib file to parse.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="c1">## This next block parses the lines in the file into a dictionary. The tricky part here is that the BibTeX</span>
        <span class="c1">## format allows for multiline entries. So we have to look for places where a line does not end in a comma, and</span>
        <span class="c1">## check the following line to see if it a continuation of that line. Unfortunately, this means we need to read</span>
        <span class="c1">## the whole file into memory --- not just one line at a time.</span>
        <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## The variable &quot;entrystr&quot; contains all of the contents of the entry between the entrytype definition &quot;@____{&quot;</span>
        <span class="c1">## and the closing brace &quot;}&quot;. Once we&#39;ve obtained all of the (in general multiline) contents, then we hand them</span>
        <span class="c1">## off to parse_bibentry() to format them.</span>
        <span class="n">entrystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">entrytype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1">## line number counter --- for error messages only</span>
        <span class="n">entry_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">abbrev_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">filehandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">## Ignore empty and comment lines.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
                <span class="c1">## If a line *starts* with a closing brace, then assume the intent is to close the current entry.</span>
                <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibentry</span><span class="p">(</span><span class="n">entrystr</span><span class="p">,</span> <span class="n">entrytype</span><span class="p">)</span>       <span class="c1">## close out the entry</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entrytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">):</span>
                    <span class="n">abbrev_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;preamble&#39;</span><span class="p">,</span><span class="s1">&#39;acronym&#39;</span><span class="p">)):</span>
                    <span class="n">entry_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">entrystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 001a: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; has data outside&#39;</span>
                          <span class="s1">&#39; of an entry {...} block. Skipping all contents until the next entry ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1">## Don&#39;t strip off leading and ending whitespace until after checking if &#39;}&#39; begins a line (as in the block</span>
            <span class="c1">## above).</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">brace_idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span>             <span class="c1">## assume a form like &quot;@ENTRYTYPE{&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">brace_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 002a: open brace not found for the entry beginning on line#&#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;. Skipping to next entry ...&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>
                <span class="n">entrytype</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">brace_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>   <span class="c1">## extract string between &quot;@&quot; and &quot;{&quot;</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">brace_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1">## If we are not currently inside an active entry, then skip the line and wait until the the next entry.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 001b: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; has data &#39;</span> <span class="o">+</span> \
                                <span class="s1">&#39;outside of an entry {...} block. Skipping all contents until the next entry ...&#39;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1">## Look if the entry ends with this line. If so, append it to &quot;entrystr&quot; and call the entry parser. If not,</span>
            <span class="c1">## then simply append to the string and continue.</span>
            <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anybrace_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">):</span>
                    <span class="n">entry_brace_level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">):</span>
                    <span class="n">entry_brace_level</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1">## If we&#39;ve found the final brace, then check if there is anything after it.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 002b: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> \
                             <span class="s1">&#39;&quot; has data outside of an entry {...} block. Skipping all &#39;</span> <span class="o">+</span> \
                             <span class="s1">&#39;contents until the next entry ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                    <span class="k">break</span>

            <span class="c1">## If we have returned to brace level 0, then finish appending the contents and send the entire set to the</span>
            <span class="c1">## parser.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">entrystr</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[:</span><span class="n">endpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="c1">## the &quot;-1&quot; here to remove the final closing brace</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibentry</span><span class="p">(</span><span class="n">entrystr</span><span class="p">,</span> <span class="n">entrytype</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">entrytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">):</span>
                    <span class="n">abbrev_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;preamble&#39;</span><span class="p">,</span><span class="s1">&#39;acronym&#39;</span><span class="p">)):</span>
                    <span class="n">entry_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">entrystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entrystr</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[:</span><span class="n">endpos</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%i</span><span class="s1"> entries and </span><span class="si">%i</span><span class="s1"> abbrevs in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entry_counter</span><span class="p">,</span> <span class="n">abbrev_counter</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="c1">#print(&#39;    Bibdata now has %i keys&#39; % (len(self.bibdata) - 1))</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.parse_bibentry"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bibentry">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bibentry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrystr</span><span class="p">,</span> <span class="n">entrytype</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a string representing the entire contents of the BibTeX-format bibliography entry, parse the contents and</span>
<span class="sd">        place them into the bibliography preamble string, the set of abbreviations, and the bibliography database</span>
<span class="sd">        dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrystr : str</span>
<span class="sd">            The string containing the entire contents of the bibliography entry.</span>
<span class="sd">        entrytype : str</span>
<span class="sd">            The type of entry (`article`, `preamble`, etc.).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entrystr</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s1">&#39;comment&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s1">&#39;preamble&#39;</span><span class="p">):</span>
            <span class="c1">## In order to use the same &quot;parse_bibfield()&quot; function as all the other options, add a fake key onto the</span>
            <span class="c1">## front of the string before calling &quot;parse_bibfield()&quot;.</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="s1">&#39;fakekey = &#39;</span> <span class="o">+</span> <span class="n">entrystr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="s1">&#39;preamble&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;fakekey&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">):</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="n">entrystr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fdkey</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fdkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 032a: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span>
                                <span class="s1">&#39;: the abbreviation &quot;&#39;</span> <span class="o">+</span> <span class="n">fdkey</span> <span class="o">+</span> <span class="s1">&#39;&quot; = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">fdkey</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; is being &#39;</span>
                                <span class="s1">&#39;overwritten as &quot;&#39;</span> <span class="o">+</span> <span class="n">fdkey</span> <span class="o">+</span> <span class="s1">&#39;&quot; = &quot;&#39;</span> <span class="o">+</span> <span class="n">fd</span><span class="p">[</span><span class="n">fdkey</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s1">&#39;acronym&#39;</span><span class="p">):</span>
            <span class="c1">## Acronym entrytypes have an identical form to &quot;string&quot; types, but we map them into a dictionary like a</span>
            <span class="c1">## regular field, so we can access them as regular database entries.</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="n">entrystr</span><span class="p">)</span>
            <span class="n">entrykey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newentry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">entrykey</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span><span class="n">fd</span><span class="p">[</span><span class="n">entrykey</span><span class="p">],</span> <span class="s1">&#39;entrytype&#39;</span><span class="p">:</span><span class="s1">&#39;acronym&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entrykey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 032b: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span>
                            <span class="s1">&#39;: the acronym &quot;&#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39;&quot; = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; is being &#39;</span>
                            <span class="s1">&#39;overwritten as &quot;&#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39;&quot; = &quot;&#39;</span> <span class="o">+</span> <span class="n">fd</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span> <span class="o">=</span> <span class="n">newentry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## First get the entry key. Then send the remainder of the entry string to the parser.</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">entrystr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entrystr</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 035: the entry starting on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; provides only an entry key (&quot;&#39;</span> <span class="o">+</span> <span class="n">entrystr</span> <span class="o">+</span> <span class="s1">&#39;&quot; and no item contents.&#39;</span><span class="p">,</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 003: the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; is does not have an &quot;,&quot; for defining the entry key. &#39;</span>
                     <span class="s1">&#39;Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

            <span class="c1">## Get the entry key. If we are culling the database (self.culldata == True) and the entry key is not among</span>
            <span class="c1">## the citation keys, then exit --- we don&#39;t need to add this to the database.</span>
            <span class="n">entrykey</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1">## If the entry is not among the list of keys to parse, then don&#39;t bother. Skip to the next entry to save</span>
            <span class="c1">## time.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entrykey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">entrystr</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">entrykey</span><span class="p">:</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 004a: the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; has an empty key. Ignoring and continuing ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">entrykey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 004b: the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; has the same key (&quot;&#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39;&quot;) as a previous &#39;</span> <span class="o">+</span> \
                     <span class="s1">&#39;entry. Overwriting the entry and continuing ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>

            <span class="c1">## Create the dictionary for the database entry. Add the entrytype and entrykey. The latter is primarily</span>
            <span class="c1">## useful for debugging, so we don&#39;t have to send the key separately from the entry itself.</span>
            <span class="n">preexists</span> <span class="o">=</span> <span class="p">(</span><span class="n">entrykey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entrytype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;entrykey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entrykey</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_only_entrykeys</span><span class="p">:</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_bibfield</span><span class="p">(</span><span class="n">entrystr</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">preexists</span><span class="p">:</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 032c: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;: the entry &quot;&#39;</span> <span class="o">+</span>
                                <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39;&quot; is being overwritten with a new definition&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fd</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.parse_bibfield"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bibfield">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bibfield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrystr</span><span class="p">,</span> <span class="n">entrykey</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For a given string representing the raw contents of a BibTeX-format bibliography entry, parse the contents into</span>
<span class="sd">        a dictionary of key:value pairs corresponding to the field names and field values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrystr : str</span>
<span class="sd">            The string containing the entire contents of the bibliography entry.</span>
<span class="sd">        entrykey : str</span>
<span class="sd">            The key of the bibliography entry being parsed (useful for error messages).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fd : dict</span>
<span class="sd">            The dictionary of &quot;field name&quot; and &quot;field value&quot; pairs.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">entrystr</span> <span class="o">=</span> <span class="n">entrystr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="p">{}</span>             <span class="c1">## the dictionary for holding key:value string pairs</span>

        <span class="k">while</span> <span class="n">entrystr</span><span class="p">:</span>
            <span class="c1">## First locate the field key.</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">entrystr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 005: the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; is an abbreviation-type entry but does not have an &quot;=&quot; &#39;</span>
                     <span class="s1">&#39;for defining the end of the abbreviation key. Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

            <span class="n">fieldkey</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fieldkey</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 033: line#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;: the &quot;&#39;</span> <span class="o">+</span> <span class="n">fieldkey</span> <span class="o">+</span>
                            <span class="s1">&#39;&quot; field of entry &quot;&#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39;&quot; is duplicated&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>

            <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">entrystr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;case_sensitive_field_names&#39;</span><span class="p">]:</span>
                <span class="n">fieldkey</span> <span class="o">=</span> <span class="n">fieldkey</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldstr</span><span class="p">:</span>
                <span class="n">entrystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">continue</span>

            <span class="c1">## Next we go through the field contents, which may involve concatenating. When we reach the end of an</span>
            <span class="c1">## individual field, we return the &quot;result string&quot; and truncate the entry string to remove the part we just</span>
            <span class="c1">## finished parsing.</span>
            <span class="n">resultstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">while</span> <span class="n">fieldstr</span><span class="p">:</span>
                <span class="n">firstchar</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">):</span>
                    <span class="c1">## Reached the end of the field, truncate the entry string return to the outer loop over fields.</span>
                    <span class="n">fd</span><span class="p">[</span><span class="n">fieldkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultstr</span>
                    <span class="n">entrystr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="c1">## Reached a concatenation operator. Just skip it.</span>
                    <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="c1">## Search for the content string that resolves the double-quote delimiter. Once you&#39;ve found the</span>
                    <span class="c1">## end delimiter, append the content string to the result string.</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">)</span>
                    <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anybraceorquote_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">break</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">endpos</span><span class="p">]</span>
                    <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldstr</span><span class="p">:</span> <span class="n">entrystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">firstchar</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">):</span>
                    <span class="c1">## Search for the endbrace that resolves the brace level. Once you&#39;ve found it, add the intervening</span>
                    <span class="c1">## contents to the result string.</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">)</span>
                    <span class="n">entry_brace_level</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anybrace_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">):</span>
                            <span class="n">entry_brace_level</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">entry_brace_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">break</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fieldstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">endpos</span><span class="p">]</span>
                    <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldstr</span><span class="p">:</span> <span class="n">entrystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## If the fieldstr doesn&#39;t begin with &#39;&quot;&#39; or &#39;{&#39; or &#39;#&#39;, then the next set of characters must be an</span>
                    <span class="c1">## abbreviation key. An abbrev key ends with a whitespace followed by either &#39;#&#39; or &#39;,&#39; (or the end</span>
                    <span class="c1">## of the field). Anything else is a syntax error.</span>
                    <span class="n">endpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">)</span>
                    <span class="n">end_of_field</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1">## The &quot;abbrevkey_pattern&quot; searches for the first &#39;#&#39; or &#39;,&#39; that is not preceded by a backslash. If</span>
                    <span class="c1">## this pattern is found, then we&#39;ve found the *end* of the abbreviation key.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abbrevkey_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">):</span>
                        <span class="c1">## If the &quot;abbrevkey&quot; is an integer, then it&#39;s not actually an abbreviation. Convert it to a</span>
                        <span class="c1">## string and insert the number itself.</span>
                        <span class="n">abbrevkey</span> <span class="o">=</span> <span class="n">fieldstr</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integer_pattern</span><span class="p">,</span> <span class="n">abbrevkey</span><span class="p">):</span>
                            <span class="n">resultstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abbrevkey</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">abbrevkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">:</span>
                                <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrevkey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 006: cannot find the abbreviation key &quot;&#39;</span> <span class="o">+</span>
                                            <span class="n">abbrevkey</span> <span class="o">+</span> <span class="s1">&#39;&quot; for the bib file entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> \
                                            <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;, . Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                                <span class="n">resultstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span>
                        <span class="n">fieldstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">end_of_field</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">fieldstr</span><span class="p">,</span> <span class="n">resultstr</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_abbrevs_with_full</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">,</span> <span class="n">resultstr</span><span class="p">)</span>

                    <span class="c1">## Since we found the comma at the end of this field&#39;s contents, we break here to return to the loop</span>
                    <span class="c1">## over fields.</span>
                    <span class="k">if</span> <span class="n">end_of_field</span><span class="p">:</span>
                        <span class="n">entrystr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">break</span>

            <span class="c1">## Strip off any unnecessary white space and remove any newlines.</span>
            <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="c1">## Having braces around quotes can cause problems when parsing nested quotes, and do not provide any</span>
            <span class="c1">## additional functionality.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;{&quot;}&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resultstr</span><span class="p">:</span>
                <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&quot;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;{&#39;}&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resultstr</span><span class="p">:</span>
                <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&#39;}&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;{`}&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">resultstr</span><span class="p">:</span>
                <span class="n">resultstr</span> <span class="o">=</span> <span class="n">resultstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{`}&#39;</span><span class="p">,</span> <span class="s1">&#39;`&#39;</span><span class="p">)</span>

            <span class="n">fd</span><span class="p">[</span><span class="n">fieldkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultstr</span>

            <span class="c1">## If the field defines a cross-reference, then add it to the &quot;searchkeys&quot;, so that when we are culling the</span>
            <span class="c1">## database for faster parsing, we do not ignore the cross-referenced entries.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fieldkey</span> <span class="o">==</span> <span class="s1">&#39;crossref&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultstr</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.parse_auxfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_auxfile">[docs]</a>    <span class="k">def</span> <span class="nf">parse_auxfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">recursive_call</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read in an `.aux` file and convert the `\citation{}` entries found there into a dictionary of citekeys and</span>
<span class="sd">        citation order number.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the `.aux` file to parse.</span>
<span class="sd">        recursive_call : bool</span>
<span class="sd">            Whether this function was called recursively (recursive_call=True), or if it is the top-level call \</span>
<span class="sd">            (recursive_call=False). Only in the latter case do we take the keylist and make self.citedict with it.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading AUX file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; ...&#39;</span><span class="p">)</span>

        <span class="c1">## Check if this file has been called before --- don&#39;t allow infinite recursion!</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxfile_list</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1">## First go through the file and grab the list of citation keys. Once we get them all, then we can go through</span>
        <span class="c1">## the list and figure out the numbering.</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">filehandle</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1">## If the line begins with &quot;\@input{&quot; then it says to go into a file and look for citations there.</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\@input{&#39;</span><span class="p">):</span>
                <span class="n">input_filename</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_auxfile</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">recursive_call</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\citation{&#39;</span><span class="p">):</span> <span class="k">continue</span>

            <span class="c1">## Remove the &quot;\citation{&quot; from the front and the &quot;}&quot; from the back. If multiple citations are given,</span>
            <span class="c1">## then split them using the comma.</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">recursive_call</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1">## If you didn&#39;t find any citations in the file, issue a warning. Otherwise, build a dictionary of keys giving</span>
        <span class="c1">## the citation keys with values equal to the citation order number. For citation order number, we can&#39;t just</span>
        <span class="c1">## start at 1 here, since some citations may occur in a recursive call to this function. Rather, we</span>
        <span class="c1">## need to look into the citation dictionary, grab the highest citation number available there, and increment.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keylist</span><span class="p">:</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 007: no citations found in AUX file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span>                   <span class="c1">## citation order counter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">q</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keylist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="c1">## When displaying the dictionary, show it in order-sorted form.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.parse_bstfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.parse_bstfile">[docs]</a>    <span class="k">def</span> <span class="nf">parse_bstfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert a Bibulous-type bibliography style template into a dictionary.</span>

<span class="sd">        The resulting dictionary consists of keys which are the various entrytypes, and values which are the template</span>
<span class="sd">        strings. In addition, any formatting options are stored in the &quot;options&quot; key as a dictionary of</span>
<span class="sd">        option_name:option_value pairs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the Bibulous style template to use.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="c1">## For the &quot;definition_pattern&quot;, rather than matching the initial string up to the first whitespace character,</span>
        <span class="c1">## we match a whitespace-equals-whitespace</span>
        <span class="n">definition_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s=\s&#39;</span><span class="p">)</span>
        <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;TEMPLATES&#39;</span>
        <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>        <span class="c1">## whether the current line is a continuation of the previous</span>
        <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">False</span>        <span class="c1">## if an unsafe object is being used, abort the user_script eval</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filehandle</span><span class="p">):</span>
            <span class="c1">## Ignore any comment lines, and remove any comments from data lines.</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>       <span class="c1">## if the line contained only a comment</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;EXECUTE {&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;EXECUTE{&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;FUNCTION {&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;The style template file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; appears to be BibTeX format, not &#39;</span>
                                  <span class="s1">&#39;Bibulous. Aborting...&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TEMPLATES:&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;TEMPLATES&#39;</span>
                <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SPECIAL-TEMPLATES:&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;SPECIAL-TEMPLATES&#39;</span>
                <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OPTIONS:&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;OPTIONS&#39;</span>
                <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DEFINITIONS:&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;DEFINITIONS&#39;</span>
                <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;VARIABLES:&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;VARIABLES&#39;</span>
                <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;DEFINITIONS&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 026a: Python script line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; contains&#39;</span>\
                         <span class="s1">&#39; an invalid use of &quot;__&quot;.</span><span class="se">\n</span><span class="s1">Aborting script evaluation ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\sos.\S&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 026b: Python script line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; contains&#39;</span>\
                         <span class="s1">&#39; an invalid call to the &quot;os&quot; module.</span><span class="se">\n</span><span class="s1">Aborting script evaluation ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\ssys.\S&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 026c: Python script line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; contains&#39;</span>\
                         <span class="s1">&#39; an invalid call to the &quot;sys&quot; module.</span><span class="se">\n</span><span class="s1">Aborting script evaluation ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\scodecs.\S&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 026c: Python script line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; contains&#39;</span>\
                         <span class="s1">&#39; an invalid call to the &quot;codecs&quot; module.</span><span class="se">\n</span><span class="s1">Aborting script evaluation ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^import\s&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 026d: Python script line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; contains&#39;</span>\
                         <span class="s1">&#39; an invalid call to &quot;import&quot;.</span><span class="se">\n</span><span class="s1">Aborting script evaluation ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^import\s&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 026e: Python script line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; contains&#39;</span>\
                         <span class="s1">&#39; an invalid call to the &quot;open()&quot; function.</span><span class="se">\n</span><span class="s1">Aborting script evaluation ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">abort_script</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">user_script</span> <span class="o">+=</span> <span class="n">line</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding a line to the BST scripting string: &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;VARIABLES&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">matchobj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">definition_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">matchobj</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 008a: line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; does not contain&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39; a valid variable definition.</span><span class="se">\n</span><span class="s1"> Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">end</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_script</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding user variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot; with value &quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot; ...&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">section</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;TEMPLATES&#39;</span><span class="p">,</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span><span class="s1">&#39;SPECIAL-TEMPLATES&#39;</span><span class="p">)):</span>
                <span class="c1">## Skip empty lines. It is tempting to put this line above here, but resist the temptation -- putting</span>
                <span class="c1">## it higher above would remove empty lines from the Python scripts in the DEFINITIONS section, which</span>
                <span class="c1">## would make troubleshooting those more difficult.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">continuation</span><span class="p">:</span>
                    <span class="c1">## If the line ends with an ellipsis, then remove the ellipsis and set continuation to True.</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">continuation</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">matchobj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">definition_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">matchobj</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 008b: line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; does not contain&#39;</span> <span class="o">+</span>\
                             <span class="s1">&#39; a valid variable definition.</span><span class="se">\n</span><span class="s1"> Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">end</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## If the line ends with an ellipsis, then remove the ellipsis and set continuation to True.</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">continuation</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">continuation</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">value</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;TEMPLATES&#39;</span><span class="p">):</span>
                    <span class="c1">## The line defines an entrytype template. Check whether this definition is overwriting an already</span>
                    <span class="c1">## existing definition.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">):</span>
                        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 009a: overwriting the existing template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> \
                             <span class="s1">&#39;&quot; from [&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;] to [&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;] ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="c1">## Find out if the template has nested option blocks. If so, then add it to</span>
                    <span class="c1">## the list of nested templates.</span>
                    <span class="n">levels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

                    <span class="c1">## Find out if the template contains an implicit loop (an ellipsis not at the end of a line). If</span>
                    <span class="c1">## so then add it to the list of looped templates.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">looped_templates</span><span class="p">):</span>
                        <span class="n">loop_data</span> <span class="o">=</span> <span class="n">get_implicit_loop_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">looped_templates</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_data</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting BST entrytype template &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot; to value &quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">):</span>
                    <span class="c1">## The variable defines an option rather than an entrytype. Check whether this definition is</span>
                    <span class="c1">## overwriting an already existing definition.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="o">!=</span> <span class="n">value</span><span class="p">):</span>\
                        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 009b: overwriting the existing template option &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot; from [&#39;</span> <span class="o">+</span> \
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;] to [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="c1">## If the value is numeric or bool, then convert the datatype from string.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting BST option &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot; to value &quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">,</span><span class="s1">&#39;False&#39;</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;name_separator&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="k">elif</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;SPECIAL-TEMPLATES&#39;</span><span class="p">):</span>
                    <span class="c1">## The line defines an entrytype template. Check whether this definition is overwriting an already</span>
                    <span class="c1">## existing definition.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">):</span>
                        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 009c: overwriting the existing special template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> \
                             <span class="s1">&#39;&quot; from [&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;] to [&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;] ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

                    <span class="c1">## If we are defining a namelist, adding it to the namelist_pair dictionary, leaving the dictionary</span>
                    <span class="c1">## value undefined for now. We will add that when we get to the implicitly indexed variables.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.to_namelist()&gt;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">namelists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

                    <span class="c1">## Find out if the template has nested option blocks. If so, then add it to</span>
                    <span class="c1">## the list of nested templates.</span>
                    <span class="n">levels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">levels</span><span class="p">:</span>
                        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 036: the style template for entrytype &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot; has unbalanced &#39;</span> <span class="o">+</span> \
                                    <span class="s1">&#39;square brackets. Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

                    <span class="c1">## Find out if the template contains an implicit loop (an ellipsis not at the end of a line). If</span>
                    <span class="c1">## so then add it to the list of looped templates.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">looped_templates</span><span class="p">):</span>
                        <span class="n">loop_data</span> <span class="o">=</span> <span class="n">get_implicit_loop_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">looped_templates</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_data</span>

                    <span class="c1">## Find out if the template contains an implicit index. If so then add it to the list of such.</span>
                    <span class="c1">## Also, if the variable has an implicit index, then it must also have a corresponding list that</span>
                    <span class="c1">## goes with it. Find out what list that is and put it into the implicit_loop_pairs dictionary.</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\.n\.&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\.n&gt;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicitly_indexed_vars</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">implicitly_indexed_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_loop_pairs</span><span class="p">):</span>
                            <span class="n">implicit_matchobj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\.n\.|\.n&gt;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">new_start</span><span class="p">,</span><span class="n">new_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">implicit_matchobj</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">implicit_loop_pairs</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">new_start</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[&lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting BST special template &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot; to value &quot;&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">abort_script</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_script</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1">## The &quot;terse_inits&quot; options has to override the &quot;period_after_initial&quot; option.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;terse_inits&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;terse_inits&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">## Next check to see whether any of the template definitions are simply maps to one of the other definitions.</span>
        <span class="c1">## For example, one BST file may have a line of the form</span>
        <span class="c1">##      inbook = incollection</span>
        <span class="c1">## which implies that the template for &quot;inbook&quot; should be mapped to the same template as defined for the</span>
        <span class="c1">## &quot;incollection&quot; entrytype.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">:</span>
            <span class="n">nwords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nwords</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

        <span class="c1">## If the user defined any functions, then we want to evaluate them in a way such that they are available in</span>
        <span class="c1">## other functions.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_script</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;allow_scripts&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating the user script:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;v&#39;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_script</span> <span class="o">+</span> <span class="s1">&#39;^&#39;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_script</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

        <span class="c1">## Next validate all of the template strings to check for formatting errors.</span>
        <span class="n">bad_templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">:</span>
            <span class="n">okay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_templatestr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">okay</span><span class="p">:</span>
                <span class="n">bad_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bad</span> <span class="ow">in</span> <span class="n">bad_templates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Error: malformed template.&#39;</span>

        <span class="c1">## The &quot;special templates&quot; have to be treated differently, since we can&#39;t just replace the template with the</span>
        <span class="c1">## &quot;malformed template&quot; message. If the template is not okay, then validate_templatestr() will emit a warning</span>
        <span class="c1">## message. If not okay, then replace the offending template with self.options[&#39;undefstr&#39;].</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">:</span>
            <span class="n">okay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_templatestr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">okay</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="c1">## When displaying the BST dictionary, show it in sorted form.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;entrytype.&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;options.&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;specials.&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.write_bblfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_bblfile">[docs]</a>    <span class="k">def</span> <span class="nf">write_bblfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_preamble</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_postamble</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bibsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a bibliography database `bibdata`, a dictionary containing the citations called out `citedict`, and a</span>
<span class="sd">        bibliography style template `bstdict` write the LaTeX-format file for the formatted bibliography.</span>

<span class="sd">        Start with the preamble and then loop over the citations one by one, formatting each entry one at a time, and</span>
<span class="sd">        put `\end{thebibliography}` at the end when done.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            The filename of the &quot;.bbl&quot; file to write. (Default is to take the AUX file and change its extension to \</span>
<span class="sd">            &quot;.bbl&quot;.)</span>
<span class="sd">        write_preamble : bool, optional</span>
<span class="sd">            Whether to write the preamble. (Setting this to False can be useful when writing the bibliography in \</span>
<span class="sd">            separate steps, as in the testing suite.)</span>
<span class="sd">        write_postamble : bool, optional</span>
<span class="sd">            Whether to write the postamble. (Setting this to False can be useful when writing the bibliography in \</span>
<span class="sd">            separate steps, as in the testing suite.)</span>
<span class="sd">        bibsize : str, optional</span>
<span class="sd">            A string the length of which is used to determine the label margin for the bibliography.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bbl&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning 034: No citations were found.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;No template file was found. Aborting writing the BBL file ...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">write_preamble</span><span class="p">:</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write_preamble</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bibsize</span><span class="p">:</span> <span class="n">bibsize</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">))</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{thebibliography}</span><span class="s1">{&#39;</span> <span class="o">+</span> <span class="n">bibsize</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">providecommand{</span><span class="se">\\</span><span class="s2">enquote}[1]{``#1&#39;&#39;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">providecommand{</span><span class="se">\\</span><span class="s1">url}[1]{{</span><span class="se">\\</span><span class="s1">tt #1}}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">providecommand{</span><span class="se">\\</span><span class="s1">href}[2]{#2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bibitemsep&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setlength{</span><span class="se">\\</span><span class="s1">itemsep}{&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bibitemsep&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;preamble&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="s1">&#39;preamble&#39;</span><span class="p">])</span>

            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">## Use a try-except block here, so that if any exception is raised then we can make sure to produce a valid</span>
        <span class="c1">## BBL file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">## First insert special variables, so that the citation sorter and everything else can use them. Also</span>
            <span class="c1">## insert cross-reference data. Doing these here means that we don&#39;t have to add lots of extra checks</span>
            <span class="c1">## later.</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
                <span class="c1">## If the citation key is not in the database, then create a fake entry with it, using entrytype</span>
                <span class="c1">## &quot;errormsg&quot;, and an item &quot;errormsg&quot; that contains the thing we want printed out in the citation</span>
                <span class="c1">## list to warn the user.</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;citation key ``&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;\&#39;</span><span class="s1"> is not in the bibliography database&#39;</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 010a: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">errormsg</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\textit{Warning: &#39;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;}.&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;errormsg&#39;</span><span class="p">:</span><span class="n">errormsg</span><span class="p">,</span> <span class="s1">&#39;entrytype&#39;</span><span class="p">:</span><span class="s1">&#39;errormsg&#39;</span><span class="p">,</span> <span class="s1">&#39;entrykey&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">insert_crossref_data</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_specials</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1">## Define a list which contains the citation keys, sorted in the order in which we need for writing into</span>
            <span class="c1">## the BBL file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_citation_list</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&lt;citealnum&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;citelabel&#39;</span><span class="p">]):</span>
                <span class="n">alphanums</span> <span class="o">=</span> <span class="n">create_alphanum_citelabels</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="s1">&#39;citelabel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;citealnum&gt;&#39;</span><span class="p">,</span><span class="n">alphanums</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;citelabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

            <span class="c1">## Write out each individual bibliography entry. Some formatting options will actually cause the entry to</span>
            <span class="c1">## be deleted, so we need the check below to see if the return string is empty before writing it to the</span>
            <span class="c1">## file.</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">:</span>
                <span class="c1">## Verbose output is for debugging.</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing entry &quot;&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;&quot; to &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; ...&#39;</span><span class="p">)</span>

                <span class="c1">## Now that we have generated all of the &quot;special&quot; fields, we can call the bibitem formatter to</span>
                <span class="c1">## generate the output for this entry.</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_bibitem</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="c1">## Need two line EOL&#39;s here and not one so that backrefs can work properly.</span>
                    <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">this_exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">this_exception</span><span class="p">)</span>
            <span class="c1">## Swallow the exception</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception encountered: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">this_exception</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">write_postamble</span><span class="p">:</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end</span><span class="si">{thebibliography}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span></div>

    <span class="c1">## ===================================</span>
<div class="viewcode-block" id="Bibdata.create_citation_list"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.create_citation_list">[docs]</a>    <span class="k">def</span> <span class="nf">create_citation_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the list of citation keys, sorted into the proper order.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">## Generate a sortkey for each citation. If the sortkeys all begin with numbers, then sort numerically</span>
        <span class="c1">## (i.e. -100 before -99, 99 before 100, etc).</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
            <span class="c1">#s = self.bibdata[c][&#39;sortkey&#39;]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">natural_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;sortkey&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>

        <span class="c1">## If using a citation order which is descending rather than ascending, then reverse the list.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;sort_order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;reverse&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">## Finally, generate the &quot;sortnum&quot; for the reference --- the order in which it will appear in the reference</span>
        <span class="c1">## list. This is different from &quot;citenum&quot;, which is the order of citation in the text. For example, if</span>
        <span class="c1">## the reference list is sorted alphabetically, but you want the list enumerated, then you need &quot;sortnum&quot;</span>
        <span class="c1">## to get the enumerated value for each reference.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;sortnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1">## If &quot;sortnum&quot; appears somewhere inside the special template definitions, where it is not yet defined,</span>
            <span class="c1">## then we need to go back and redo the specials.</span>
            <span class="n">foundit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;sortnum&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="n">foundit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">foundit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_specials</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;citekey=</span><span class="si">%25s</span><span class="s1">: sortkey=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.format_bibitem"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.format_bibitem">[docs]</a>    <span class="k">def</span> <span class="nf">format_bibitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">citekey</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the &quot;\bibitem{...}&quot; string to insert into the &quot;.bbl&quot; file.</span>

<span class="sd">        This is the workhorse function of Bibulous. For a given citation key, find the resulting entry in the</span>
<span class="sd">        bibliography database. From the entry&#39;s `entrytype`, lookup the relevant template in bstdict and start</span>
<span class="sd">        replacing template variables with formatted elements of the database entry. Once you&#39;ve replaced all template</span>
<span class="sd">        variables, you&#39;re done formatting that entry. Write the result to the BBL file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        citekey : str</span>
<span class="sd">            The citation key.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        itemstr : str</span>
<span class="sd">            The string containing the \bibitem{} citation key and LaTeX-formatted string for the formatted \</span>
<span class="sd">            bibliography. (That is, this string is designed to be inserted directly into the LaTeX document.)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">citekey</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;preamble&#39;</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">entrytype</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span>

        <span class="c1">## If the journal format uses ProcSPIE like a journal, then you need to change the entrytype from</span>
        <span class="c1">## &quot;inproceedings&quot; to &quot;article&quot;, and add a &quot;journal&quot; field.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;procspie_as_journal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s1">&#39;inproceedings&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="s1">&#39;series&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Proc. SPIE&#39;</span><span class="p">,</span><span class="s1">&#39;procspie&#39;</span><span class="p">]):</span>
            <span class="n">entrytype</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;journal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Proc.</span><span class="se">\\</span><span class="s1"> SPIE&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">entrytype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">entrytype</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">entrytype</span> <span class="o">==</span> <span class="s1">&#39;errormsg&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;citelabel&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
                <span class="n">itemstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\bibitem{&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;errormsg&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">itemstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\bibitem[&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;citelabel&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]{&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;errormsg&#39;</span><span class="p">]</span>
            <span class="k">return</span><span class="p">(</span><span class="n">itemstr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;entrytype &quot;&#39;</span> <span class="o">+</span> <span class="n">entrytype</span> <span class="o">+</span> <span class="s1">&#39;&quot; does not have a template defined in the .bst file&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 011: &#39;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;. Skipping ...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1">## Before checking which variables are defined and which not, we first need to evaluate the user-defined</span>
        <span class="c1">## variables or else they will always be &quot;undefined&quot;. To make this work, we also need to provide the user</span>
        <span class="c1">## shortcut names:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_variables</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;allow_scripts&#39;</span><span class="p">]:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>      <span class="c1"># pyflakes:ignore</span>
            <span class="k">assert</span> <span class="n">options</span>
            <span class="n">citedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span>    <span class="c1"># pyflakes:ignore</span>
            <span class="n">bstdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span>      <span class="c1"># pyflakes:ignore</span>
            <span class="n">bibdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span>      <span class="c1"># pyflakes:ignore</span>
            <span class="k">for</span> <span class="n">user_var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_variables</span><span class="p">:</span>
                <span class="n">user_var_value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_variables</span><span class="p">[</span><span class="n">user_var_name</span><span class="p">])</span>
                <span class="n">entry</span><span class="p">[</span><span class="n">user_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_var_value</span>

        <span class="n">bibitem_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;citelabel&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bibitem_label</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\bibitem{&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\bibitem[&#39;</span> <span class="o">+</span> <span class="n">bibitem_label</span> <span class="o">+</span> <span class="s1">&#39;]{&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Formatting entry &quot;&#39;</span> <span class="o">+</span> <span class="n">citekey</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Template: &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstdict</span><span class="p">[</span><span class="n">entrytype</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Field data: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">## Substitute the template variables with fields from the bibliography entry.</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_substitution</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="n">citekey</span><span class="p">)</span>
            <span class="c1">## Add the filled-in template string onto the &quot;\bibitem{...}\n&quot; line in front of it.</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span> <span class="o">+</span> <span class="n">templatestr</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">itemstr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textit{&#39;</span> <span class="o">+</span> <span class="n">err</span> <span class="o">+</span> <span class="s1">&#39;}.&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 013: &#39;</span> <span class="o">+</span> <span class="n">err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>

        <span class="c1">## If there are nested operators on the string, replace all even-level operators with \{}. Is there any need to</span>
        <span class="c1">## do this with \textbf{} and \texttt{} as well?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">itemstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textit{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">enwrap_nested_string</span><span class="p">(</span><span class="n">itemstr</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">),</span> <span class="n">odd_operator</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\textit&#39;</span><span class="p">,</span> \
                                           <span class="n">even_operator</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\textup&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">itemstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textbf{&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">enwrap_nested_string</span><span class="p">(</span><span class="n">itemstr</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">),</span> <span class="n">odd_operator</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\textbf&#39;</span><span class="p">,</span> \
                                           <span class="n">even_operator</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\textmd&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wrap_nested_quotes&#39;</span><span class="p">]:</span>
            <span class="c1">## If there are any nested quotation marks in the string, then we need to modify the formatting properly.</span>
            <span class="c1">## If there are any apostrophes or foreign words that use apostrophes in the string then the current code</span>
            <span class="c1">## will raise an exception.</span>
            <span class="n">itemstr</span> <span class="o">=</span> <span class="n">enwrap_nested_quotes</span><span class="p">(</span><span class="n">itemstr</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">itemstr</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.insert_crossref_data"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.insert_crossref_data">[docs]</a>    <span class="k">def</span> <span class="nf">insert_crossref_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">fieldname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert crossref info into a bibliography database dictionary.</span>

<span class="sd">        Loop through a bibliography database dictionary and, for each entry which has a &quot;crossref&quot; field, locate the</span>
<span class="sd">        crossref entry and insert any missing bibliographic information into the main entry&#39;s fields.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrykey : str</span>
<span class="sd">            The key of the bibliography entry to query.</span>
<span class="sd">        fieldname : str, optional</span>
<span class="sd">            The name of the field to check. If fieldname==None, then check all fields.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        foundit : bool</span>
<span class="sd">            Whether the function found a crossref for the queried field. If multiple fieldnames were input, then \</span>
<span class="sd">            `foundit` will be True if a crossref is located for any one of them.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## First check that the entrykey exists.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;errormsg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;crossref&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="n">bibentry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fieldname</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bibentry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>

        <span class="c1">## Check that the cross-referenced entry actually exists. If not, then just move on.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
            <span class="n">crossref_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 015: bad cross reference. Entry &quot;&#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39;&quot; refers to &#39;</span> <span class="o">+</span> <span class="s1">&#39;entry &quot;&#39;</span> <span class="o">+</span> \
                 <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;, which doesn</span><span class="se">\&#39;</span><span class="s1">t exist.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">crossref_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">]][</span><span class="n">k</span><span class="p">]</span>

        <span class="c1">## What a &quot;booktitle&quot; is in the entry is normally a &quot;title&quot; in the crossref.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">crossref_keys</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;booktitle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;booktitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">]][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.write_citeextract"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_citeextract">[docs]</a>    <span class="k">def</span> <span class="nf">write_citeextract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">write_abbrevs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract a sub-database from a large bibliography database, with the former containing only those entries cited</span>
<span class="sd">        in the .aux file (and any relevant cross-references).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filedict :  str</span>
<span class="sd">            The dictionary filenames must have keys &quot;aux&quot;,  &quot;bst&quot;, and &quot;bib&quot;.</span>
<span class="sd">        outputfile : str, optional</span>
<span class="sd">            The filename to use for writing the extracted BIB file.</span>
<span class="sd">        write_abbrevs : bool</span>
<span class="sd">            Whether or not to write the abbreviations to the BIB file. Since the abbreviations are already inserted \</span>
<span class="sd">            into the database entries, they are no longer needed, but may be useful for future editing and adding of \</span>
<span class="sd">            entries to the database file.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## The &quot;citedict&quot; contains only those items directly cited, but we also need any cross-referenced items as</span>
        <span class="c1">## well, so let&#39;s add those.</span>
        <span class="n">crossref_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;crossref&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">):</span>
                <span class="n">crossref_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">])</span>

        <span class="n">citekeylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crossref_list</span><span class="p">:</span> <span class="n">citekeylist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">crossref_list</span><span class="p">)</span>

        <span class="c1">## A dict comprehension to extract only the relevant items in &quot;bibdata&quot;. Note that these entries are mapped by</span>
        <span class="c1">## reference and not by value --- any changes to &quot;bibextract&quot; will also be reflected in &quot;self.bibdata&quot; is the</span>
        <span class="c1">## change is to a mutable entry (such as a list or a dict).</span>
        <span class="n">bibextract</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citekeylist</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">}</span>
        <span class="n">abbrevs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span> <span class="k">if</span> <span class="n">write_abbrevs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">export_bibfile</span><span class="p">(</span><span class="n">bibextract</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">abbrevs</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.write_authorextract"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_authorextract">[docs]</a>    <span class="k">def</span> <span class="nf">write_authorextract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searchname</span><span class="p">,</span> <span class="n">outputfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_abbrevs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract a sub-database from a large bibliography database, with the former containing only those entries citing</span>
<span class="sd">        the given author/editor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        searchname : str or dict</span>
<span class="sd">            The string or dictionary for the author&#39;s name. This can be, for example, &quot;Bugs E. Bunny&quot; or \</span>
<span class="sd">            {&#39;first&#39;:&#39;Bugs&#39;, &#39;last&#39;:&#39;Bunny&#39;, &#39;middle&#39;:&#39;E&#39;}.</span>
<span class="sd">        outputfile : str, optional</span>
<span class="sd">            The filename of the extracted BIB file to write.</span>
<span class="sd">        write_abbrevs : bool</span>
<span class="sd">            Whether or not to write the abbreviations to the BIB file. Since the abbreviations are already inserted \</span>
<span class="sd">            into the database entries, they are no longer needed, but may be useful for future editing and adding of \</span>
<span class="sd">            entries to the database file.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">searchname</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The input search name [&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">searchname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;] is not a valid string.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputfile</span><span class="p">:</span>
            <span class="n">outputfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;aux&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_authorextract.bib&#39;</span>

        <span class="n">searchname</span> <span class="o">=</span> <span class="n">namestr_to_namedict</span><span class="p">(</span><span class="n">searchname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
        <span class="n">nkeys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchname</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">]</span>

        <span class="c1">## Find out if any of the tokens in the search name are initials. If so, then we need to perform the search</span>
        <span class="c1">## over initialized names and not full names. Save the set of booleans (one for each name part) in a dictionary</span>
        <span class="c1">## to use in the search loop below.</span>
        <span class="n">name_is_initialized</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">searchname</span><span class="p">:</span>
            <span class="n">name_is_initialized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">searchname</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="c1">## This is the dictionary we will stuff extracted entries into.</span>
        <span class="n">bibextract</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1">## count the number of entries found</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span>
            <span class="c1">## Get the list of name dictionaries from the entry.</span>
            <span class="n">name_list_of_dicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;author&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="n">name_list_of_dicts</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;author&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;editor&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;editor&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;author&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">name_list_of_dicts</span> <span class="o">=</span> <span class="n">namelist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## If the entry has both authors and editors, then just merge the two name lists.</span>
                    <span class="n">name_list_of_dicts</span> <span class="o">+=</span> <span class="n">namelist</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">name_list_of_dicts</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1">## Compare each name dictionary in the entry with the input author&#39;s name dict. All of an author&#39;s name</span>
            <span class="c1">## keys must equal an entry&#39;s name key to produce a match.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list_of_dicts</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">searchname</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]):</span> <span class="k">continue</span>

                <span class="n">key_matches</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">namekey</span> <span class="ow">in</span> <span class="n">searchname</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">namekey</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">name_is_initialized</span><span class="p">[</span><span class="n">namekey</span><span class="p">]:</span>
                            <span class="n">thisname</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">namekey</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">thisname</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">namekey</span><span class="p">]</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">thisname</span> <span class="o">==</span> <span class="n">searchname</span><span class="p">[</span><span class="n">namekey</span><span class="p">]):</span>
                            <span class="n">key_matches</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found match in entry &quot;</span><span class="si">%s</span><span class="s1">&quot;: name[</span><span class="si">%s</span><span class="s1">] = </span><span class="si">%s</span><span class="s1"> from &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> \
                                      <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">namekey</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">namekey</span><span class="p">],</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key_matches</span> <span class="o">==</span> <span class="n">nkeys</span><span class="p">):</span>
                    <span class="n">bibextract</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">bibextract</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;entrykey&#39;</span><span class="p">]</span>
                    <span class="n">nentries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Match FULL NAME in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;&quot;: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="n">abbrevs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span> <span class="k">if</span> <span class="n">write_abbrevs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">export_bibfile</span><span class="p">(</span><span class="n">bibextract</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">abbrevs</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.replace_abbrevs_with_full"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.replace_abbrevs_with_full">[docs]</a>    <span class="k">def</span> <span class="nf">replace_abbrevs_with_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">,</span> <span class="n">resultstr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given an input str, locate the abbreviation key within it and replace the abbreviation with its full form.</span>

<span class="sd">        Once the abbreviation key is found, remove it from the &quot;fieldstr&quot; and add the full form to the &quot;resultstr&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        fieldstr : str</span>
<span class="sd">            The string to search for the abbreviation key.</span>
<span class="sd">        resultstr : str</span>
<span class="sd">            The thing to hold the abbreviation&#39;s full form. (Note that it might not be empty on input.)</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        fieldstr : str</span>
<span class="sd">            The string to search for the abbreviation key.</span>
<span class="sd">        resultstr : str</span>
<span class="sd">            The thing to hold the abbreviation&#39;s full form.</span>
<span class="sd">        end_of_field : bool</span>
<span class="sd">            Whether the abbreviation key was at the end of the current field.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">end_of_field</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">## The &quot;abbrevkey_pattern&quot; searches for the first &#39;#&#39; or &#39;,&#39; that is not preceded by a backslash. If this</span>
        <span class="c1">## pattern is found, then we&#39;ve found the *end* of the abbreviation key.</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abbrevkey_pattern</span><span class="p">,</span> <span class="n">fieldstr</span><span class="p">):</span>
            <span class="n">endpos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">abbrevkey</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[:</span><span class="n">endpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1">## If the &quot;abbreviation&quot; is an integer, then it&#39;s not an abbreviation but rather a number, and just</span>
                <span class="c1">## return it as-is.</span>
                <span class="k">if</span> <span class="n">abbrevkey</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_abbrevs&#39;</span><span class="p">]:</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abbrevkey</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">abbrevkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 016a: for the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                         <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;, cannot find the abbreviation key &quot;&#39;</span> <span class="o">+</span> <span class="n">abbrevkey</span> <span class="o">+</span> <span class="s1">&#39;&quot;. Skipping ...&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrevkey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">abbrevkey</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[:</span><span class="n">endpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1">## If the &quot;abbreviation&quot; is an integer, then it&#39;s not an abbreviation</span>
                <span class="c1">## but rather a number, and just return it as-is.</span>
                <span class="k">if</span> <span class="n">abbrevkey</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_abbrevs&#39;</span><span class="p">]:</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abbrevkey</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">abbrevkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 016b: for the entry ending on line #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of file &quot;&#39;</span> <span class="o">+</span> \
                         <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;, cannot find the abbreviation key &quot;&#39;</span> <span class="o">+</span> <span class="n">abbrevkey</span> <span class="o">+</span> <span class="s1">&#39;&quot;. Skipping ...&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resultstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrevkey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="n">fieldstr</span> <span class="o">=</span> <span class="n">fieldstr</span><span class="p">[</span><span class="n">endpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">end_of_field</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s1">&#39;if-else mismatch inside replace_abbrevs_with_full().&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fieldstr</span><span class="p">,</span> <span class="n">resultstr</span><span class="p">,</span> <span class="n">end_of_field</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.write_auxfile"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.write_auxfile">[docs]</a>    <span class="k">def</span> <span class="nf">write_auxfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given the input database file(s) and style file(s), write out an AUX file containing citations to all unique</span>
<span class="sd">        database entries.</span>

<span class="sd">        This function is only provided as a utility, and is not actually used except during troubleshooting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The filename of the auxfile to write.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;aux&#39;</span><span class="p">]</span>

        <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">citation{&#39;</span> <span class="o">+</span> <span class="n">entry</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">bibdata{&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bib&#39;</span><span class="p">]:</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bib&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">bibstyle{&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bst&#39;</span><span class="p">]:</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bst&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.get_bibfilenames"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.get_bibfilenames">[docs]</a>    <span class="k">def</span> <span class="nf">get_bibfilenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If the input is a filename ending in `.aux`, then read through the `.aux` file and locate the lines</span>
<span class="sd">        `\bibdata{...}` and `\bibstyle{...}` to get the filename(s) for the bibliography database and style template.</span>

<span class="sd">        Also determine whether to set the `culldata` flag. If the input is a single AUX filename, then the default is</span>
<span class="sd">        to set culldata=True. If the input is a list of filenames, then assume that this is the complete list of files</span>
<span class="sd">        to use (i.e. ignore the contents of the AUX file except for generating the citedict), and set culldata=False.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The &quot;auxiliary&quot; file, containing citation info, TOC info, etc.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filedict : dict</span>
<span class="sd">            A dictionary with keys `aux`, `bbl`, `bib`, `bst`, `extract`, and `tex`, each entry of which contains a \</span>
<span class="sd">            list of filenames.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">bibfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bstfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxfile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">bblfile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">texfile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">extractfile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">bibres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bstres</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.aux&#39;</span><span class="p">):</span>
            <span class="n">auxfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">auxfile</span><span class="p">))</span>

            <span class="n">s</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">bibdata{&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
                    <span class="n">indx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
                    <span class="n">bibres</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">indx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">bibstyle{&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                    <span class="n">indx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
                    <span class="n">bstres</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">indx</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bibres</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bibulous cannot find a bibliography database specified in &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;. &#39;</span>
                                 <span class="s1">&#39;Aborting generation of BBL file&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bstres</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bibulous cannot find a bibliography template specified in &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;. &#39;</span>
                                 <span class="s1">&#39;Aborting generation of BBL file&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1">## Now we have the strings from the &quot;.tex&quot; file that describing the bibliography filenames. If these are</span>
            <span class="c1">## lists of filenames, then split them out.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">bibres</span><span class="p">):</span>
                <span class="n">bibres</span> <span class="o">=</span> <span class="n">bibres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>      <span class="c1">## if a list of files, then split up the list pieces</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bibres</span> <span class="o">=</span> <span class="p">[</span><span class="n">bibres</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bibres</span><span class="p">:</span>
                <span class="c1">## If the filename is missing the extension, then add it.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bib&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;.bib&#39;</span>

                <span class="c1">## If the filename has a relative address, convert it to an absolute one. Linux absolute paths begin</span>
                <span class="c1">## with a forward slash. Windows absolute paths begin with a drive letter and a colon.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                <span class="n">bibfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

            <span class="c1">## Next do the same thing for the &quot;.bst&quot; files.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">bstres</span><span class="p">):</span>
                <span class="n">bstres</span> <span class="o">=</span> <span class="n">bstres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>      <span class="c1">## if a list of files, then split up the list pieces</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bstres</span> <span class="o">=</span> <span class="p">[</span><span class="n">bstres</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bstres</span><span class="p">:</span>
                <span class="c1">## If the filename is missing the extension, then add it.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bst&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">+=</span> <span class="s1">&#39;.bst&#39;</span>

                <span class="c1">## If the filename has a relative address, convert it to an absolute one. Linux absolute paths begin</span>
                <span class="c1">## with a forward slash Windows absolute paths begin with a drive letter and a colon.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                <span class="n">bstfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

            <span class="c1">## Finally, normalize the file strings to work on any platform.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bibfiles</span><span class="p">)):</span>
                <span class="n">bibfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">bibfiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bstfiles</span><span class="p">)):</span>
                <span class="n">bstfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">bstfiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1">## Or if the input is only a BIB file, then go off of that.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bib&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">bibfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)]</span>

        <span class="c1">## Or of the input is a list, then we can go through all the filenames in the list.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">culldata</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">## All the work above was to locate the filenames from a single AUX file. However, if the input is a list of</span>
            <span class="c1">## filenames, then constructing the filename dictionary is simple.</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.aux&#39;</span><span class="p">):</span> <span class="n">auxfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bib&#39;</span><span class="p">):</span> <span class="n">bibfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bst&#39;</span><span class="p">):</span> <span class="n">bstfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bbl&#39;</span><span class="p">):</span> <span class="n">bblfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tex&#39;</span><span class="p">):</span> <span class="n">texfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bblfile</span><span class="p">:</span>
            <span class="n">bblfile</span> <span class="o">=</span> <span class="n">auxfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.bbl&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">texfile</span> <span class="ow">and</span> <span class="n">auxfile</span><span class="p">:</span>
            <span class="n">texfile</span> <span class="o">=</span> <span class="n">auxfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extractfile</span><span class="p">:</span>
            <span class="n">extractfile</span> <span class="o">=</span> <span class="n">auxfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-extract.bib&#39;</span>

        <span class="c1">## Now that we have the filenames, build the dictionary of BibTeX-related files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibfiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bstfiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;tex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;aux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bbl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bblfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;extract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extractfile</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bib files: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">bibfiles</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bst files: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">bstfiles</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tex file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">texfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;aux file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">auxfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bbl file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bblfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ext file: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">extractfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.check_citekeys_in_datakeys"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.check_citekeys_in_datakeys">[docs]</a>    <span class="k">def</span> <span class="nf">check_citekeys_in_datakeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check to see if all of the citation keys (from the AUX file) exist within the current set of database entrykeys.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_complete : bool</span>
<span class="sd">            True if all citations exist in the database, False otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">citekeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">)</span>
        <span class="n">datakeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">citekeys</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">datakeys</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking the overlap between citation keys and database keys ...&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The list of keys not found in the current database:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.add_crossrefs_to_searchkeys"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.add_crossrefs_to_searchkeys">[docs]</a>    <span class="k">def</span> <span class="nf">add_crossrefs_to_searchkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add any cross-referenced entrykeys into the `searchkeys`, the list which is used to cull the database so that</span>
<span class="sd">        only necessary entries are parsed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## When self.culldata==True, the problem is that if a crossref refers to an entry that was not among the</span>
        <span class="c1">## citation keys, then the database parser will not know to place that entry into the bibdata dictionary. Thus,</span>
        <span class="c1">## if we happen to run across an entry with missing data, and it has a crossref that is not in the database,</span>
        <span class="c1">## then we have to go back and parse the database a second time, this time adding the crossreferenced items.</span>
        <span class="c1">## Once that&#39;s done, *then* we can add cross-referenced data into the original cited entries.</span>
        <span class="n">crossref_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;crossref&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">crossref_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;crossref&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">crossref_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchkeys</span> <span class="o">+=</span> <span class="n">crossref_list</span>
        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.insert_specials"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.insert_specials">[docs]</a>    <span class="k">def</span> <span class="nf">insert_specials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert &quot;special&quot; fields into a database entry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entrykey : str</span>
<span class="sd">            The key of the entry to which we want to add special fields.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;pages&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
            <span class="p">(</span><span class="n">startpage</span><span class="p">,</span><span class="n">endpage</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_pagerange</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">],</span> <span class="n">entrykey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;startpage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startpage</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;endpage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpage</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;doi&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;autocomplete_doi&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://dx.doi.org/&#39;</span><span class="p">):</span>
                <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://dx.doi.org/&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span>

        <span class="c1">## Define the variables &quot;citekey&quot; and &quot;citenum&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;citekey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entrykey</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
            <span class="c1">#ncites = len(self.citedict)</span>
            <span class="c1">#ndigits = 1 + int(log10(ncites))    ## note that this requires import of: from math import log10</span>
            <span class="n">citenum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citedict</span><span class="p">[</span><span class="n">entrykey</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">citenum</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;citenum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citenum</span>

        <span class="c1">## Next loop through the &quot;special&quot; variables. These are variable definitions from the SPECIAL-</span>
        <span class="c1">## TEMPLATES section of the style file. Note that rather than looping through</span>
        <span class="c1">## self.specials&#39; keys, we loop through &quot;self.specials_list&quot; because we want it to be ordered.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials_list</span><span class="p">:</span>
            <span class="c1">## Only insert the user-defined special field if the field is missing.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1">## Need to treat citealpha specially. Check if it needs to be present before anything else is defined.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&lt;citealpha.&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;&lt;citealpha&gt;&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
                <span class="n">citealpha</span> <span class="o">=</span> <span class="n">create_citation_alpha</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;citealpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">citealpha</span>

            <span class="c1">## If this special template is an implicitly indexed one, then it can only be used after explicit index</span>
            <span class="c1">## replacement (such as within an implicit loop) and not by itself, so we have to skip it here. We</span>
            <span class="c1">## can&#39;t use &quot;if (key in self.implicitly_indexed_vars)&quot; here because the &quot;key&quot; contains the implicit</span>
            <span class="c1">## index too (i.e. &quot;name.n&quot; and not &quot;name&quot;), and so the strings in the &quot;implicitly_indexed_vars&quot; list</span>
            <span class="c1">## are not quite what we have in our keys here.</span>
            <span class="n">template_has_implicit_index</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">implicit_index_pattern</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\.n\.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\.n$&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">template_has_implicit_index</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1">## Substitute other entry fields into the template to generate the formatted result. Note that if the</span>
            <span class="c1">## special template contains an implicit loop, then we DO NOT fill it out here. Filling out an implicit loop</span>
            <span class="c1">## has to be done while performing template substitution because it requires querying entry fields, and is</span>
            <span class="c1">## not a matter of creating entry fields.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_substitution</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">templatekey</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

            <span class="c1">## Insert the result as a new field in the database entry. Note that the &quot;(self.options[&#39;undefstr&#39;] not in res)&quot;</span>
            <span class="c1">## piece of code is not quite ideal, but it is an easy solution that has a low probability of breaking</span>
            <span class="c1">## (low prob. that a user will need to use the &quot;undefstr&quot; in a template).</span>
            <span class="k">if</span> <span class="n">template_has_implicit_index</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

        <span class="k">return</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.validate_templatestr"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.validate_templatestr">[docs]</a>    <span class="k">def</span> <span class="nf">validate_templatestr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Validate the template string so that it contains no formatting errors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template string to be validated.</span>
<span class="sd">        key : str</span>
<span class="sd">            The name of the variable that uses this template.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        okay : bool</span>
<span class="sd">            Whether or not the template is properly formatted.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">okay</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">## Make sure that there are the same number of open as closed brackets.</span>
        <span class="n">num_obrackets</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
        <span class="n">num_cbrackets</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_obrackets</span> <span class="o">!=</span> <span class="n">num_cbrackets</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;In the template for &quot;&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;&quot; there are &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_obrackets</span><span class="p">)</span> <span class="o">+</span> \
                  <span class="s1">&#39; open brackets &quot;[&quot;, but &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cbrackets</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; close brackets &quot;]&quot; in the formatting string&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 012: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">## Check that no &#39;]&#39; appears before a &#39;[&#39;.</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;A closed bracket &quot;]&quot; occurs before a corresponding open bracket &quot;[&quot; in the &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 027: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">## Finally, check that no &#39;[&#39;, &#39;]&#39;, or &#39;|&#39; appear inside a variable name.</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;An invalid &quot;[&quot; character appears inside the template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 028a: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;]&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;An invalid &quot;]&quot; character appears inside the template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 028b: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;An invalid &quot;|&quot; character appears inside the template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 028c: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;An invalid &quot;&lt;&quot; character appears inside the template variable &quot;&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 028d: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span><span class="p">(</span><span class="n">okay</span><span class="p">)</span></div>

    <span class="c1">## ===================================</span>
<div class="viewcode-block" id="Bibdata.fillout_implicit_indices"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.fillout_implicit_indices">[docs]</a>    <span class="k">def</span> <span class="nf">fillout_implicit_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">templatekey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        From a template containing an implicit loop (&#39;...&#39; notation), build a full-size template without an ellipsis.</span>

<span class="sd">        Right now, the code only allows one implicit loop in any given template.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The input template string (containing the implicit loop ellipsis notation).</span>
<span class="sd">        entrykey : str</span>
<span class="sd">            The key of the bibliography entry to query.</span>
<span class="sd">        templatekey : str</span>
<span class="sd">            If this template is for a special variable rather than an entrytype, then this key will tell which \</span>
<span class="sd">            special variable is being operated on.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_templatestr : str</span>
<span class="sd">            The new template with the ellipsis replaced with the loop-generated template variables and &quot;glue&quot;.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## To look for an indexed variable, it has to have the form of a (dot plus an integer), or (dot plus &#39;n&#39;), or</span>
        <span class="c1">## (dot plus &#39;N&#39;); and then followed by either another dot or by &#39;&gt;&#39;.</span>
        <span class="n">has_index</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_pattern</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">has_implicit_loop</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_implicit_loop</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_index</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">has_index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_implicit_loop</span><span class="p">:</span>
            <span class="c1">## Get a list of the indexed variables.</span>
            <span class="n">indexed_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_vars_in_template</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">indexed_vars</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">get_variable_name_elements</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;n&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">):</span>
                    <span class="c1">## Replace &quot;.n&quot; with &quot;.&quot; plus an explicit index.</span>
                    <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">varname</span><span class="p">])</span>
                    <span class="n">templatestr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=\.)n(?=\.)|(?&lt;=\.)n(?=&gt;)&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">templatestr</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">],</span> <span class="n">templatestr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>
        <span class="n">num_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

        <span class="c1">## Get the key for the template to look up in the looped template data dictionary (generated when the BST</span>
        <span class="c1">## file is parsed).</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">templatekey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">templatekey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span>

        <span class="n">loop_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">looped_templates</span><span class="p">[</span><span class="n">templatekey</span><span class="p">]</span>
        <span class="n">loop_varname</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]</span>
        <span class="n">loop_start_index</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;start_index&#39;</span><span class="p">]</span>
        <span class="n">regular_glue</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;glue&#39;</span><span class="p">]</span>
        <span class="n">loop_lhs_prefix</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;var_prefix&#39;</span><span class="p">]</span>
        <span class="n">loop_lhs_suffix</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;var_suffix&#39;</span><span class="p">]</span>
        <span class="n">loop_end_index</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;end_index&#39;</span><span class="p">]</span>
        <span class="n">last_glue</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;last_glue&#39;</span><span class="p">]</span>
        <span class="n">last_glue_if_only_two</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;last_glue_if_only_two&#39;</span><span class="p">]</span>
        <span class="n">before_loop_stuff</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;before_loop_stuff&#39;</span><span class="p">]</span>
        <span class="n">after_loop_stuff</span> <span class="o">=</span> <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;after_loop_stuff&#39;</span><span class="p">]</span>

        <span class="c1">## Check that the indices are valid.</span>
        <span class="k">if</span> <span class="n">loop_start_index</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">loop_start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loop_start_index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">loop_start_index</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
            <span class="n">loop_start_index</span> <span class="o">=</span> <span class="n">num_names</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 031a: the template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed. The index element &quot;&#39;</span> <span class="o">+</span> \
                  <span class="n">loop_start_index</span> <span class="o">+</span> <span class="s1">&#39;&quot; is not recognized.&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1">## Check that the indices are valid.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loop_end_index</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">loop_end_index</span> <span class="o">!=</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 031b: the template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed. The index element &quot;&#39;</span> <span class="o">+</span> \
                  <span class="n">loop_end_index</span> <span class="o">+</span> <span class="s1">&#39;&quot; is not recognized.&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1">## What is the maximum number of allowed names? If the number of names in the namelist is more than the maximum</span>
        <span class="c1">## allowed, then we need to replace the end of the formatted namelist with the &quot;etal_message&quot;. Note that, in</span>
        <span class="c1">## BibTeX-formatted name fields, if the last name is simply &quot;others&quot;, then it signals that the list is</span>
        <span class="c1">## incomplete, and we should add an &quot;et al.&quot; message.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;others&#39;</span><span class="p">):</span>
            <span class="n">maxnames</span> <span class="o">=</span> <span class="n">num_names</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">loop_end_index</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
            <span class="n">maxnames</span> <span class="o">=</span> <span class="n">num_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxnames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loop_end_index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">too_many_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">&gt;</span> <span class="n">maxnames</span><span class="p">)</span>
        <span class="n">loop_end_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">num_names</span><span class="p">,</span><span class="n">maxnames</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loop_end_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">loop_end_index</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">## If there are only two items in the list to loop over, then use &quot;last_glue_if_only_two&quot;, else use &quot;last_glue&quot;.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">rhs_glue</span> <span class="o">=</span> <span class="n">last_glue_if_only_two</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs_glue</span> <span class="o">=</span> <span class="n">last_glue</span>

        <span class="c1">## Create the implicit loop, applying &quot;glue&quot; between each template variable that you generate. Here we take the</span>
        <span class="c1">## part of the variable name to the left of the index and the part to the right of the index, and put them</span>
        <span class="c1">## back together while replacing the index &quot;n&quot; with the number determined by the loop index.</span>
        <span class="n">new_templatestr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loop_start_index</span><span class="p">,</span> <span class="n">loop_end_index</span><span class="p">):</span>
            <span class="n">name_part</span> <span class="o">=</span> <span class="n">loop_varname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="c1">## Next find if the variable name itself has a template.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name_part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">):</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">name_part</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">loop_varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicitly_indexed_vars</span><span class="p">):</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">loop_varname</span> <span class="o">+</span> <span class="s1">&#39;.n&#39;</span><span class="p">]</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.n\.&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">name_part</span><span class="p">)</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.n&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">name_part</span><span class="p">)</span>

            <span class="n">new_templatestr</span> <span class="o">+=</span> <span class="n">name_part</span> <span class="o">+</span> <span class="n">loop_lhs_suffix</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">loop_end_index</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
               <span class="n">new_templatestr</span> <span class="o">+=</span> <span class="n">regular_glue</span>

        <span class="c1">## Now do the same thing for the endpoint variable of the implicit loop. The endpoint is handled outside of the</span>
        <span class="c1">## loop itself because the &quot;glue&quot; element is often different between the penultimate and the ultimate names.</span>
        <span class="k">if</span> <span class="n">too_many_names</span><span class="p">:</span>
            <span class="n">new_templatestr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;etal_message&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">name_part</span> <span class="o">=</span> <span class="n">loop_varname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name_part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">):</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">name_part</span><span class="p">]</span>
                <span class="n">new_templatestr</span> <span class="o">+=</span> <span class="n">rhs_glue</span> <span class="o">+</span> <span class="n">name_part</span> <span class="o">+</span> <span class="n">loop_lhs_suffix</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">loop_varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicitly_indexed_vars</span><span class="p">):</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span><span class="p">[</span><span class="n">loop_varname</span> <span class="o">+</span> <span class="s1">&#39;.n&#39;</span><span class="p">]</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.n\.&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">name_part</span><span class="p">)</span>
                <span class="n">name_part</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.n&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">name_part</span><span class="p">)</span>
                <span class="n">new_templatestr</span> <span class="o">+=</span> <span class="n">rhs_glue</span> <span class="o">+</span> <span class="n">name_part</span> <span class="o">+</span> <span class="n">loop_lhs_suffix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_templatestr</span> <span class="o">+=</span> <span class="n">rhs</span>

        <span class="n">new_templatestr</span> <span class="o">=</span> <span class="n">before_loop_stuff</span> <span class="o">+</span> <span class="n">new_templatestr</span> <span class="o">+</span> <span class="n">after_loop_stuff</span>

        <span class="k">return</span><span class="p">(</span><span class="n">new_templatestr</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.template_substitution"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.template_substitution">[docs]</a>    <span class="k">def</span> <span class="nf">template_substitution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">templatekey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Substitute database entry variables into template string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template string itself.</span>
<span class="sd">        entrykey : dict</span>
<span class="sd">            The key of the database entry from which to get fields to substitute into the template.</span>
<span class="sd">        templatekey : str</span>
<span class="sd">            If this template is for a special variable rather than an entrytype, then this key will tell which \</span>
<span class="sd">            special variable is being operated on.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template string with all variables replaced.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">bibentry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]</span>

        <span class="c1">## Fill out the template if there is an implicit loop structure.</span>
        <span class="n">template_has_implicit_index</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">implicit_index_pattern</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">template_has_implicit_loop</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">template_has_implicit_loop</span><span class="p">:</span>
            <span class="c1">## In order to check if all of the variables use din an implicit loop are undefined, we make a template</span>
            <span class="c1">## string in which all of the variables are replaced with &quot;???&quot;, and check to see if the result equals</span>
            <span class="c1">## that.</span>
            <span class="n">templatestr_all_undef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">],</span> <span class="n">templatestr</span><span class="p">)</span>

        <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillout_implicit_indices</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">templatekey</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">templatekey</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">is_nested</span> <span class="o">=</span> <span class="p">(</span><span class="n">templatekey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_nested</span> <span class="o">=</span> <span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_templates</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span>

        <span class="c1">## Don&#39;t call the nested version of removing template option brackets if you don&#39;t have to, because it has to</span>
        <span class="c1">## do significant extra work.</span>
        <span class="k">if</span> <span class="n">is_nested</span><span class="p">:</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_nested_template_options_brackets</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_template_options_brackets</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>

        <span class="n">var_options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">## Go ahead and replace all of the template variables with the corresponding fields.</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span> <span class="k">continue</span>

            <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>     <span class="c1">## remove angle brackets to extract just the name</span>

            <span class="c1">## The &quot;title&quot; variable has to be treated specially to deal with punctuation conflicts.</span>
            <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_title_into_template</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;citealpha&#39;</span><span class="p">):</span>
                <span class="c1">## Before we parse the template string to remove any undefined variables, we need to make sure that</span>
                <span class="c1">## the entry has all the proper variables in it.</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">create_citation_alpha</span><span class="p">(</span><span class="n">bibentry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;citealnum&#39;</span><span class="p">):</span>
                <span class="c1">## The &quot;citealphanum&quot; style has to be handled outside of the usual specials loop --- it requires</span>
                <span class="c1">## that *all* of the citelist be fully defined before it can start.</span>
                <span class="k">continue</span>

            <span class="c1">## If the variable contains a function asking for initials, then one tricky part is that the &quot;middle&quot;</span>
            <span class="c1">## name part of a name dictionary can have multiple elements, so that each one needs to be initialed</span>
            <span class="c1">## independently (and a period would thus need to be added to each separately). Note that &quot;var_options&quot;</span>
            <span class="c1">## has to be kept separate from &quot;options&quot;.</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">period_after_initial</span> <span class="o">=</span> <span class="p">(</span><span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;initial()&gt;.&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                                       <span class="p">(</span><span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">-</span><span class="mi">16</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;initial().tie()&gt;.&#39;</span><span class="p">)</span>
                <span class="n">var_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">:</span><span class="n">period_after_initial</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

            <span class="c1">## Get the result of querying the variable in the entry. This will replace the template variable.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">bibentry</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">var_options</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">dict</span><span class="p">)):</span>
                <span class="c1">## If the object is a list and not a string, then we need to return it immediately, since the</span>
                <span class="c1">## steps below assume a string.</span>
                <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">template_has_implicit_index</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">res</span><span class="p">):</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

        <span class="c1">## If the template uses an implicit loop, check if all variables were undefined. If none are defined, then the</span>
        <span class="c1">## whole template should be returned as undefined.</span>
        <span class="k">if</span> <span class="n">template_has_implicit_loop</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">templatestr</span> <span class="o">==</span> <span class="n">templatestr_all_undef</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">## Now that we&#39;ve replaced template variables, go ahead and replace the special commands. We need to replace</span>
        <span class="c1">## the hash symbol too because that indicates a comment when placed inside a template string.</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeopenbracket}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeopenbracket}&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeclosebracket}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeclosebracket}&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeverticalbar}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeverticalbar}&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makegreaterthan}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makegreaterthan}&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makelessthan}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makelessthan}&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makehashsign}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makehashsign}&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">#&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeellipsis}&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{\makeellipsis}&#39;</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span></div>

    <span class="c1">## ===================================</span>
<div class="viewcode-block" id="Bibdata.insert_title_into_template"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.insert_title_into_template">[docs]</a>    <span class="k">def</span> <span class="nf">insert_title_into_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title_var</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Insert the title field into a template string.</span>

<span class="sd">        This requires more work than simply performing a string replacement, because there can be punctuation conflicts</span>
<span class="sd">        when the title itself ends with punctuation, while the template itself has punctuation immediately following the</span>
<span class="sd">        title.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        title_var : str</span>
<span class="sd">            The title variable (which may simply be &quot;&lt;title&gt;&quot;, or may have operators attached to the variable name.</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template to insert the title into.</span>
<span class="sd">        bibentry : dict</span>
<span class="sd">            The bibliography entry to get the title from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template with the variable replaced with the &quot;title&quot; field, with possible operators applied.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">bibentry</span><span class="p">,</span> <span class="n">title_var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>

        <span class="c1">## If the template string has punctuation right after the title, and the title itself also has punctuation,</span>
        <span class="c1">## then you may get something like &quot;Title?,&quot; where the two punctuation marks conflict. In that case, keep</span>
        <span class="c1">## the title&#39;s punctuation and drop the template&#39;s.</span>
        <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;?&#39;</span><span class="p">,</span><span class="s1">&#39;!&#39;</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">title_var</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_var</span><span class="p">)]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;!&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">,</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">)):</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[:</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">title_var</span><span class="p">)]</span> <span class="o">+</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">title_var</span><span class="p">):]</span>

        <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">title_var</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.remove_nested_template_options_brackets"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.remove_nested_template_options_brackets">[docs]</a>    <span class="k">def</span> <span class="nf">remove_nested_template_options_brackets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a template string, go through each options sequence [...] and search for undefined variables. In each</span>
<span class="sd">        sequence, return only the block of each sequence in which all variables are defined (i.e. with outer braces</span>
<span class="sd">        removed).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The string defining the template to analyze.</span>
<span class="sd">        entry : dict</span>
<span class="sd">            The bibliography database entry inside which to look for variables.</span>
<span class="sd">        variables : list of str</span>
<span class="sd">            The variables to look for.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">while</span> <span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">templatestr</span><span class="p">):</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>

            <span class="c1">## If there is no nesting left then go ahead and parse the remaining string.</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">):</span>
                <span class="n">templatestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_template_options_brackets</span><span class="p">(</span><span class="n">templatestr</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>

            <span class="c1">## Find the start and end indices of all top-level option sequences.</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">start_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">start_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">end_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1">## To keep the code tractable, just work with the first pair of (start_idx,end_idx) values, rather than looping</span>
            <span class="c1">## through every pair in the string. We can catch the next pair in the next pass through the loop.</span>
            <span class="n">substr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">start_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="n">toplevel_split</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
            <span class="n">newblocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                <span class="n">block_variables</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
                <span class="n">newblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_nested_template_options_brackets</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">block_variables</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">newblock</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)):</span>
                    <span class="n">newblocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newblock</span><span class="p">)</span>

            <span class="n">new_substr</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newblocks</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_template_bracket</span><span class="p">(</span><span class="n">new_substr</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[:</span><span class="n">start_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">end_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.remove_template_options_brackets"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.remove_template_options_brackets">[docs]</a>    <span class="k">def</span> <span class="nf">remove_template_options_brackets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a template string, go through each options sequence [...] and search for undefined variables. In each</span>
<span class="sd">        sequence, return only the block of each sequence in which all variables are defined.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The string defining the template to analyze.</span>
<span class="sd">        entry : dict</span>
<span class="sd">            The bibliography database entry inside which to look for variables.</span>
<span class="sd">        variables : list of str</span>
<span class="sd">            The variables to look for.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">num_obrackets</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>

        <span class="c1">## Do a nested search. From the beginning of the formatting string look for the first &#39;[&#39;, and the first &#39;]&#39;. If</span>
        <span class="c1">## they are out of order, raise an exception. Note that this assumes that the square brackets cannot be nested.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_obrackets</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_idx</span> <span class="o">&lt;</span> <span class="n">end_idx</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;A closed bracket &quot;]&quot; occurs before an open bracket &quot;[&quot; in the format &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1">## Remove the outer square brackets, and use the resulting substring as an input to the parser.</span>
            <span class="n">substr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">start_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

            <span class="c1">## In each options train, go through and replace the whole train with the one block that has a defined value.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_template_bracket</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
            <span class="n">templatestr</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[:</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.simplify_template_bracket"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.simplify_template_bracket">[docs]</a>    <span class="k">def</span> <span class="nf">simplify_template_bracket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        From an &quot;options train&quot; `[...|...|...]`, find the first fully defined block in the sequence.</span>

<span class="sd">        A style template string contains grammatical features of the form `[...|...|...]`, which we can call options</span>
<span class="sd">        sequences. Each &quot;block&quot; in the sequence (divided from the others by a `|` symbol), contains fields which, if</span>
<span class="sd">        defined, replace the entire options sequence in the returned string.</span>

<span class="sd">        When the options sequence ends with &quot;|]&quot; (i.e. at least one of the blocks is required to be defined) but we</span>
<span class="sd">        find that none of the blocks have all their variables defined, then we replace the entire block with the</span>
<span class="sd">        &quot;undefstr&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The string containing a complete entrytype bibliography style template.</span>
<span class="sd">        variables : list of str</span>
<span class="sd">            The list of variables defined within the template string.</span>
<span class="sd">        bibentry : dict</span>
<span class="sd">            An entry from the bibliography database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        arg : str</span>
<span class="sd">              The string giving the entrytype block to replace an options sequence.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        simplify_template_bracket() is given an options sequence &quot;[&lt;title&gt;|&lt;booktitle&gt;]&quot; that contains two blocks. The code looks</span>
<span class="sd">        into the bibliography entry and does not find a &quot;title&quot; entry but does find a &quot;booktitle&quot; entry. So, the function</span>
<span class="sd">        returns &quot;&lt;booktitle&gt;&quot;, without square brackets, thereby replacing the sequence with the proper defined variable.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">block_sequence</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>

        <span class="c1">## Go through the if/elseif/else train of blocks within the string one by one. In each block, see if there are</span>
        <span class="c1">## any variables defined. If no variables are present, then the block is &quot;defined&quot; and we return that block</span>
        <span class="c1">## (i.e. replacing the train with that block). If an argument is defined, strip its surrounding &#39;&lt;&#39; and &#39;&gt;&#39; and</span>
        <span class="c1">## look to see if the variable is defined in the bibdata entry. If so, the variable is defined and we return</span>
        <span class="c1">## the &#39;&lt;var&gt;&#39; version of the variable (later code will do the variable replacement). If the variable is</span>
        <span class="c1">## undefined (not present in the bibdata entry) then skip to the next block. If there is no next block, or if</span>
        <span class="c1">## the block is empty (which means undefined by definition) then set the result to be the &quot;undefined string&quot;.</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">block_sequence</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]</span>
                <span class="k">break</span>

            <span class="c1">## If no variable exists inside the options-block, then just copy the text inside the block.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">block</span>
                <span class="k">break</span>

            <span class="c1">## Construct a list of the unique variables in the block.</span>
            <span class="n">block_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">block</span><span class="p">]))</span>

            <span class="c1">## Loop through the list of variables and find which ones are defined within the bibliography entry. If any</span>
            <span class="c1">## variables within the block are undefined, then return an empty string.</span>
            <span class="n">foundit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">block_variables</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>             <span class="c1">## remove the angle brackets</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">bibentry</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
                <span class="n">foundit</span> <span class="o">=</span> <span class="p">((</span><span class="n">res</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">foundit</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1">## If after going through all of the variables in a block, we have located definitions for all of them,</span>
            <span class="c1">## then the entire block is defined, and we can return it without evaluating the next block.</span>
            <span class="k">if</span> <span class="n">foundit</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">block</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.get_variable"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.get_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the variable (i.e. entry field) from within the current bibliography entry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bibentry : dict</span>
<span class="sd">            The bibliography entry to search.</span>
<span class="sd">        variable : str</span>
<span class="sd">            The dot-indexed template variable to evaluate.</span>
<span class="sd">        options : dict</span>
<span class="sd">            An optional dictionary giving extra info (such as whether to insert dots after initials).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : str</span>
<span class="sd">            The field value (if it exists). If no corresponding field is found, return `None`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## If there is no dot-indexer in the variable name, then return the entry field corresponding to the variable,</span>
        <span class="c1">## if it exists in the entry.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="n">variable</span><span class="p">]))</span>

        <span class="c1">## If there *is* a dot-indexer in the variable name, then we have to do some parsing. First we check the</span>
        <span class="c1">## leftmost part (the field being indexed). If that doesn&#39;t exist then we&#39;re done --- the variable is</span>
        <span class="c1">## undefined.</span>
        <span class="n">var_parts</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bibentry</span><span class="p">):</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">var_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">## When using the &quot;uniquify&quot; operator, we need to be able to tell it the variable name. Use the &quot;options&quot;</span>
        <span class="c1">## dictionary to get the variable&#39;s name into the &quot;get_indexed_variable()&quot; function, so we don&#39;t need to</span>
        <span class="c1">## add an extra input variable.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.uniquify(&#39;</span> <span class="ow">in</span> <span class="n">variable</span><span class="p">):</span>
            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;varname&#39;</span><span class="p">:</span><span class="n">fieldname</span><span class="p">})</span>

        <span class="n">indexer</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">bibentry</span><span class="p">[</span><span class="n">fieldname</span><span class="p">],</span> <span class="n">indexer</span><span class="p">,</span> <span class="n">bibentry</span><span class="p">[</span><span class="s1">&#39;entrykey&#39;</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.format_operator_arg"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.format_operator_arg">[docs]</a>    <span class="k">def</span> <span class="nf">format_operator_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If the operator argument begins with &quot;option.&quot; then return the content of the options variable following the dot. If there is not &quot;option.&quot;</span>
<span class="sd">        at the beginning of the argument, then it&#39;s just a regular string.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;option.&#39;</span><span class="p">):</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">option_name</span><span class="p">)</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">option_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option_name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;undefstr&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">varname</span>
        <span class="k">return</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.get_indexed_variable"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.get_indexed_variable">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">indexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the result of dot-indexing into a field. This can be accessing an element of a list or dictionary, or the result</span>
<span class="sd">        of operating on a string with a function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str</span>
<span class="sd">            The field to operate on.</span>
<span class="sd">        indexer : str</span>
<span class="sd">            The dot-delimited indexing operator.</span>
<span class="sd">        entrykey : str</span>
<span class="sd">            The entrykey of the bibliography entry being evaluated (useful for error messages).</span>
<span class="sd">        options : dict</span>
<span class="sd">            An optional dictionary giving extra info (such as whether to insert dots after initials).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : str</span>
<span class="sd">            The string resulting from the dot-indexing operation on the field. If a valid operation cannot be performed,\</span>
<span class="sd">            then return &quot;None&quot;.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        dict1 = {&#39;first&#39;:&#39;John&#39;, &#39;middle&#39;:&#39;A&#39;, &#39;last&#39;:&#39;Smith&#39;}</span>
<span class="sd">        dict2 = {&#39;first&#39;:&#39;Ramsey&#39;, &#39;middle&#39;:&#39;M Z&#39;, &#39;last&#39;:&#39;Taylor&#39;}</span>
<span class="sd">        field = [dict1, dict2]</span>
<span class="sd">        get_indexed_variable(field, &#39;0.last.initial()&#39;)</span>
<span class="sd">        &gt;&gt;&gt; S</span>
<span class="sd">        get_indexed_variable(field, &#39;1.first&#39;)</span>
<span class="sd">        &gt;&gt;&gt; Ramsey</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## We need to split the string by the &quot;dot&quot; character, but **not** when the dot lies between a pair of parentheses ---</span>
        <span class="c1">## that means that it&#39;s part of an operator argument!</span>
        <span class="n">index_elements</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">index_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_elements</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">nelements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_elements</span><span class="p">)</span>

        <span class="c1">## If the indexing element is an integer, then we assume that it wants a list or tuple. If it finds one, then get the indexed item.</span>
        <span class="k">if</span> <span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">fieldname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span>
                <span class="n">indexname</span> <span class="o">=</span> <span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 029a: the &#39;</span> <span class="o">+</span> <span class="n">fieldname</span> <span class="o">+</span> <span class="s1">&#39;field of entry &#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39; is not a list and thus is &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;not indexable by &quot;&#39;</span> <span class="o">+</span> <span class="n">indexname</span> <span class="o">+</span> <span class="s1">&#39;&quot;. Aborting template substitution&#39;</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newindexer</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>

        <span class="c1">## If the thing to the right of the dot-indexer is a *function*, then map the field to the function.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.initial()&#39;</span><span class="p">):</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.frenchinitial()&#39;</span><span class="p">):</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.compress()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.tie()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.sentence_case()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">sentence_case</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.ordinal()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">get_edition_ordinal</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.monthname()&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthnames</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthnames</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.monthabbrev()&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthabbrevs</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthabbrevs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.to_namelist()&#39;</span><span class="p">):</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">]</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">entrykey</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.format_authorlist()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">format_namelist</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">nametype</span><span class="o">=</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.format_editorlist()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">format_namelist</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">nametype</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.lower()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.upper()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.null()&#39;</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.zfill(&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.zfill\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">nzeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nzeros</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">str_is_integer</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">nzeros</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">nzeros</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.replace(&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.replace\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="ow">in</span> <span class="n">field</span><span class="p">):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span>

                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.purify()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;uniquify(1)&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">+</span><span class="s1">&#39;1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]):</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                        <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">newfield</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]):</span>
                            <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="c1">#print(&#39;varname=%s, field=%s, newfield=%s&#39; % (options[&#39;varname&#39;], field, newfield))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newindexer</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;uniquify(a)&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]):</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">):</span>
                            <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>               <span class="c1">## 97 == &#39;a&#39;, 98 == &#39;b&#39;, etc.</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">52</span><span class="p">):</span>
                            <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>   <span class="c1">## double up if a single append doesn&#39;t work</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">78</span><span class="p">):</span>
                            <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span>   <span class="c1">## triple up if necessary</span>
                        <span class="n">newfield</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                        <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">newfield</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]):</span>
                            <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uniquify_vars</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="c1">#print(&#39;varname=%s, field=%s, newfield=%s&#39; % (options[&#39;varname&#39;], field, newfield))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newindexer</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.if_singular(&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.if_singular\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">13</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="c1">## remove function name and parentheses</span>
                <span class="p">(</span><span class="n">variable_to_eval</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">variable_to_eval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">variable_to_eval</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>

                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.if_str_equal(&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.if_str_equal(\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">14</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="c1">## remove function name and parentheses</span>
                <span class="p">(</span><span class="n">test_str</span><span class="p">,</span> <span class="n">then_form</span><span class="p">,</span> <span class="n">else_form</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">test_str</span><span class="p">):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">then_form</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">else_form</span>

                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.remove_leading_zeros()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">23</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.len()&#39;</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.if_num_equals(&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.if_num_equals\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">18</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                  <span class="c1">## remove function name and parentheses</span>
                <span class="p">(</span><span class="n">variable_to_eval</span><span class="p">,</span> <span class="n">test_length</span><span class="p">,</span> <span class="n">return_if_equal</span><span class="p">,</span> <span class="n">return_if_unequal</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">variable_to_eval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">variable_to_eval</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_length</span><span class="p">)):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">return_if_equal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">return_if_unequal</span><span class="p">)</span>

                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.if_less_than(&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.if_less_than\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">14</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="c1">## remove function name and parentheses</span>
                <span class="p">(</span><span class="n">variable_to_eval</span><span class="p">,</span> <span class="n">test_length</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">variable_to_eval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">variable_to_eval</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_length</span><span class="p">)):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>

                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">indexer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.if_greater_than(&#39;</span><span class="p">):</span>
                <span class="c1">#print(&#39;&gt;&gt;&gt;&#39;)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.if_greater_than\(.*\)&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">17</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="c1">## remove function name and parentheses</span>
                <span class="p">(</span><span class="n">variable_to_eval</span><span class="p">,</span> <span class="n">test_length</span><span class="p">,</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">variable_to_eval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">]):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bibdata</span><span class="p">[</span><span class="n">entrykey</span><span class="p">][</span><span class="n">variable_to_eval</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_length</span><span class="p">)):</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_operator_arg</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>

                <span class="c1">#print(&#39;&gt;&gt;&gt;&#39;)</span>
                <span class="c1">#print(self.bibdata[entrykey])</span>
                <span class="c1">#print(variable_to_eval)</span>
                <span class="c1">#print(int(self.bibdata[entrykey][variable_to_eval]))</span>
                <span class="c1">#print(int(test_length))</span>
                <span class="c1">#print(newfield)</span>
                <span class="c1">#print(&#39;&gt;&gt;&gt;&#39;)</span>

                <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 029c: the template for entry &#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39; has an unknown function &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;. Aborting template substitution&#39;</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">## If the indexer is a numerical range...</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^.-?\d*:-?\d*&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">):</span>
            <span class="n">indexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>   <span class="c1">## remove the leading period</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^.-?\d*:-?\d*&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="p">)</span>
            <span class="p">(</span><span class="n">start_idx</span><span class="p">,</span><span class="n">end_idx</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_idx</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">start_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">start_idx</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">end_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">field</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">newindexer</span> <span class="o">=</span> <span class="n">indexer</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newindexer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1">## If the thing to the right of the dot-indexer is a string, then we have to assume that it is an index into a</span>
        <span class="c1">## dictionary. Check if the field is a dict type.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span>
            <span class="n">indexname</span> <span class="o">=</span> <span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 029d: the &#39;</span> <span class="o">+</span> <span class="n">fieldname</span> <span class="o">+</span> <span class="s1">&#39;field of entry &#39;</span> <span class="o">+</span> <span class="n">entrykey</span> <span class="o">+</span> <span class="s1">&#39; is not a dictionary and thus is &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;not indexable by &quot;&#39;</span> <span class="o">+</span> <span class="n">indexname</span> <span class="o">+</span> <span class="s1">&#39;&quot;. Aborting template substitution&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newfield</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nelements</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="n">newfield</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newindexer</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">index_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_variable</span><span class="p">(</span><span class="n">newfield</span><span class="p">,</span> <span class="n">newindexer</span><span class="p">,</span> <span class="n">entrykey</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>

        <span class="c1">## The code should never reach here!</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 029e: Invalid field type error. Aborting template substitution&#39;</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.get_indexed_vars_in_template"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.get_indexed_vars_in_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_indexed_vars_in_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get a list of the indexed variables within a template.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template to analyze.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        indexed_vars : list of str</span>
<span class="sd">            The list of variable names that are indexed variables.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">)</span>
        <span class="n">indexed_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">found_indexed_var</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_pattern</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">found_indexed_var</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">varname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indexed_vars</span><span class="p">):</span>
                    <span class="n">indexed_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">indexed_vars</span><span class="p">)</span></div>

    <span class="c1">## =============================</span>
<div class="viewcode-block" id="Bibdata.get_names"><a class="viewcode-back" href="../bibulous.html#bibulous.Bibdata.get_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">templatestr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the list of names associated with a given entry, giving priority to the first namelist</span>
<span class="sd">        present in the &quot;namelists&quot; list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entry : dict</span>
<span class="sd">            The bibliography data entry.</span>
<span class="sd">        templatestr : str</span>
<span class="sd">            The template string -- to tell whether to use authors or editors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namelist : list of dicts</span>
<span class="sd">            The list of names found.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">## Make a list of the variables in the templatestr so we can do string compares. To do this, we get the</span>
        <span class="c1">## list of indexed variables, select only the first one (they should all be the same), and then strip off</span>
        <span class="c1">## the index from the end of the variable.</span>
        <span class="n">template_indexed_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indexed_vars_in_template</span><span class="p">(</span><span class="n">templatestr</span><span class="p">)</span>
        <span class="n">indexed_var</span> <span class="o">=</span> <span class="n">get_variable_name_elements</span><span class="p">(</span><span class="n">template_indexed_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">implicit_loop_pairs</span><span class="p">[</span><span class="n">indexed_var</span><span class="p">]</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
            <span class="n">listname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_loop_pairs</span><span class="p">[</span><span class="n">indexed_var</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">listname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## There is no corresponding namelist available for this variable, so we treat the variable as undefined.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div></div>

<span class="c1">## ================================================================================================</span>
<span class="c1">## END OF BIBDATA CLASS.</span>
<span class="c1">## ================================================================================================</span>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="sentence_case"><a class="viewcode-back" href="../bibulous.html#bibulous.sentence_case">[docs]</a><span class="k">def</span> <span class="nf">sentence_case</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reduce the case of the string to lower case, except for the first character in the string, and except if any given</span>
<span class="sd">    character is at nonzero brace level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to be modified.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : str</span>
<span class="sd">        The resulting modified string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

    <span class="c1">## Next we look for LaTeX commands, given by a backslash followed by a non-word character. Do not reduce those</span>
    <span class="c1">## characters in the LaTeX command to lower case. To facilitate that, add one to the brace level for each of those</span>
    <span class="c1">## character positions.</span>
    <span class="n">brlevel</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">\w+&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
        <span class="n">brlevel</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">brlevel</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]]</span>

    <span class="c1">## Convert the string to a character list for easy in-place modification.</span>
    <span class="n">charlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">charlist</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">brlevel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">charlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">charlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">charlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="stringsplit"><a class="viewcode-back" href="../bibulous.html#bibulous.stringsplit">[docs]</a><span class="k">def</span> <span class="nf">stringsplit</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39; |(?&lt;!</span><span class="se">\\</span><span class="s1">)~&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string into tokens, taking care not to allow the separator to act unless at brace level zero.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tokens : list of str</span>
<span class="sd">        The list of tokens.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## The item separating the name tokens can be either a space character or a tilde, if the tilde is not preceded by a</span>
    <span class="c1">## backslash (in which case it instead represents an accent character and not a separator).</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1">## Record the indices of the start and end of the match.</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>

        <span class="n">ntokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ntokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ntokens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1">## Go through each match&#39;s indices and split the string at each.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">ntokens</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c1">## the end of *this* separator</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nexti</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>      <span class="c1">## the beginning of the *next* separator</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c1">## the end of *this* separator</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">nexti</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="namefield_to_namelist"><a class="viewcode-back" href="../bibulous.html#bibulous.namefield_to_namelist">[docs]</a><span class="k">def</span> <span class="nf">namefield_to_namelist</span><span class="p">(</span><span class="n">namefield</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parse a name field (&quot;author&quot; or &quot;editor&quot;) of a BibTeX entry into a list of dicts, one for each person.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namefield : str</span>
<span class="sd">        Either the &quot;author&quot; field of a database entry or the &quot;editor&quot; field.</span>
<span class="sd">    key : str, optional</span>
<span class="sd">        The bibliography data entry key.</span>
<span class="sd">    sep : str, optional</span>
<span class="sd">        The string defining what to use as a name separator.</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namelist : list</span>
<span class="sd">        A list of dictionaries, with one dictionary for each name. Each dict has keys &quot;first&quot;, &quot;middle&quot;, &quot;prefix&quot;, \</span>
<span class="sd">        &quot;last&quot;, and &quot;suffix&quot;. The &quot;last&quot; key is the only one that is required.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">namefield</span> <span class="o">=</span> <span class="n">namefield</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">namelist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sep_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;\s&#39;</span><span class="p">)</span>

    <span class="c1">## Look for common typos.</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;,\s&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 017a: The name string in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;&quot; has &quot; &#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;, &quot;, which is likely a&#39;</span>
             <span class="s1">&#39; typo. Continuing on anyway ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">sep</span><span class="p">,</span> <span class="n">namefield</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 017b: The name string in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;&quot; has &quot;, &#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;&quot;, which is likely a&#39;</span>
             <span class="s1">&#39; typo. Continuing on anyway ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;\s+&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;\s&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 017c: The name string in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;&quot; has two &quot;&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;&quot;s separated by spaces, &#39;</span>
             <span class="s1">&#39;which is likely a typo. Continuing on anyway ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="c1">## Replace the two &quot;and&quot;s with just one &quot;and&quot;.</span>
        <span class="n">namefield</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=\s)&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;\s+&#39;</span><span class="o">+</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;(?=\s)&#39;</span><span class="p">,</span> <span class="n">namefield</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>

    <span class="c1">## Split the string of names into individual strings, one for each complete name. Here we can split on whitespace</span>
    <span class="c1">## surround the word &quot;and&quot; so that &quot;{and}&quot; and &quot;word~and~word&quot; will not allow the split. Need to treat the case of a</span>
    <span class="c1">## single author separate from that of multiple authors in order to return a single-element *list* rather than a</span>
    <span class="c1">## scalar.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sep_pattern</span><span class="p">,</span> <span class="n">namefield</span><span class="p">):</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="n">namestr_to_namedict</span><span class="p">(</span><span class="n">namefield</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">namedict</span><span class="p">:</span>
            <span class="n">namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namefield</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep_pattern</span><span class="p">,</span> <span class="n">namefield</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## If there are braces in the string, then we need to be careful to only allow splitting of the names when</span>
            <span class="c1">## &#39; and &#39; is at brace level 0. This requires replacing re.split() with a bunch of low-level code.</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">namefield</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="n">separators</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">sep_pattern</span><span class="p">,</span> <span class="n">namefield</span><span class="p">):</span>
                <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1">## Record the indices of the start and end of the match.</span>
                    <span class="n">separators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>

            <span class="n">num_names</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">separators</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_names</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">separators</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">[:</span><span class="n">separators</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="c1">## Go through each match&#39;s indices and split the string at each.</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">num_names</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c1">## the end of *this* separator</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nexti</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>      <span class="c1">## the beginning of the *next* separator</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c1">## the end of *this* separator</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefield</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">nexti</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="n">nauthors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nauthors</span><span class="p">):</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">namestr_to_namedict</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">disable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namedict</span><span class="p">:</span>
                <span class="n">namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="initialize_name"><a class="viewcode-back" href="../bibulous.html#bibulous.initialize_name">[docs]</a><span class="k">def</span> <span class="nf">initialize_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    From an input name element (first, middle, prefix, last, or suffix) , convert it to its initials.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name element to be converted.</span>
<span class="sd">    options : dict of bools, optional</span>
<span class="sd">        &#39;french_intials&#39;: whether to initialize digraphs with two letters instead of the default of one.\</span>
<span class="sd">            For example, if use_french_initials==True, then &quot;Christian&quot; -&gt; &quot;Ch.&quot;, not &quot;C.&quot;.</span>
<span class="sd">        &#39;period_after_initial&#39;: whether to include a &#39;.&#39; after the author initial.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_name : str</span>
<span class="sd">        The name element converted to its initials form.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;period_after_initial&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;french_initials&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1">## Go through the author&#39;s name elements and truncate the first and middle names to their initials. If using French</span>
    <span class="c1">## initials, then a hyphenated name produces hyphenated initials (for example &quot;Jean-Paul&quot; -&gt; &quot;J.-P.&quot; and not &quot;J.&quot;),</span>
    <span class="c1">## and a name beginning with a digraph produces a digraph initial, so that Philippe -&gt; Ph. (not P.), and</span>
    <span class="c1">## Christian -&gt; Ch. (not C.).</span>
    <span class="n">digraphs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Ch&#39;</span><span class="p">,</span><span class="s1">&#39;Gn&#39;</span><span class="p">,</span><span class="s1">&#39;Ll&#39;</span><span class="p">,</span><span class="s1">&#39;Ph&#39;</span><span class="p">,</span><span class="s1">&#39;Ss&#39;</span><span class="p">,</span><span class="s1">&#39;Th&#39;</span><span class="p">)</span>
    <span class="n">period</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="c1">## Split the name by spaces (primarily used for middle name strings, which may have multiple names in them), and</span>
    <span class="c1">## remove any empty list elements produced by the split. Also remove any parenthetical names (such as used for</span>
    <span class="c1">## nicknames).</span>
    <span class="n">nametokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
    <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nametokens</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">token</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">token</span><span class="p">):</span>
            <span class="c1">## If the name is hyphenated, then initialize the hyphenated parts of it, and assemble the result by</span>
            <span class="c1">## combining initials with the hyphens. That is, &quot;Chein-Ing&quot; -&gt; &quot;C.-I.&quot;.</span>
            <span class="n">pieces</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">nametokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">period</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">initialize_name</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pieces</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## If the token already ends in a period then it might already be an initial, but only if it has length 2.</span>
            <span class="c1">## Otherwise you still need to truncate it. If the name only has one character in it, then treat it as a</span>
            <span class="c1">## full name that doesn&#39;t need initializing.</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">nametokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">period</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_initials&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">token</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">digraphs</span><span class="p">):</span>
                    <span class="n">nametokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">period</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nametokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">period</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nametokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

    <span class="n">newname</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="n">newname</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializer input [&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;] --&gt; output [&#39;</span> <span class="o">+</span> <span class="n">newname</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="get_delim_levels"><a class="viewcode-back" href="../bibulous.html#bibulous.get_delim_levels">[docs]</a><span class="k">def</span> <span class="nf">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">),</span> <span class="n">operator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a list of level numbers for each character in a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to characterize.</span>
<span class="sd">    delims : tuple of two strings</span>
<span class="sd">        The (left-hand-side delimiter, right-hand-side delimiter).</span>
<span class="sd">    operator : str</span>
<span class="sd">        The &quot;operator&quot; string that appears to the left of the delimiter. For example, operator=r&#39;\textbf&#39; allows the \</span>
<span class="sd">        code to look for nested structures like `{...}` and simultaneously for structures like `\textbf{...}`, and be \</span>
<span class="sd">        able to keep track of which is which.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    levels : list of ints</span>
<span class="sd">        A list giving the operator delimiter level (or &quot;brace level&quot; if no operator is given) of each character in \</span>
<span class="sd">        the string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">oplevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c1">## operator level</span>
    <span class="n">brlevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c1">## brace level</span>

    <span class="c1">## Locate the left-delimiters and increment the level each time we find one.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">oplevels</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">delims</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">operator</span><span class="p">):</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">operator</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>       <span class="c1">## add an &quot;operator&quot; marker to the stack</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>       <span class="c1">## add a &quot;brace level&quot; marker to the stack</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">delims</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1">## If the stack is empty but the delimiter level isn&#39;t resolved, then the braces are unbalanced.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span> <span class="k">return</span><span class="p">([])</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span> <span class="n">oplevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">brlevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">oplevels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">brlevels</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="show_levels_debug"><a class="viewcode-back" href="../bibulous.html#bibulous.show_levels_debug">[docs]</a><span class="k">def</span> <span class="nf">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">levels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A debugging tool for showing delimiter levels and the input string next to one another.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string used to determine the delimiter levels.</span>
<span class="sd">    levels : list of ints</span>
<span class="sd">        The list of delimiter levels at each character position in the string.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1">## counter for the character ending a line</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">q</span><span class="p">:</span><span class="n">q</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)])[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">levels</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">return</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="get_quote_levels"><a class="viewcode-back" href="../bibulous.html#bibulous.get_quote_levels">[docs]</a><span class="k">def</span> <span class="nf">get_quote_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a list which gives the &quot;quotation level&quot; of each character in the string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to analyze.</span>
<span class="sd">    disable : list of ints, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alevels : list of ints</span>
<span class="sd">        The double-quote-level for (``,&#39;&#39;) pairs in the string.</span>
<span class="sd">    blevels : list of ints</span>
<span class="sd">        The single-quote-level for (`,&#39;) pairs in the string.</span>
<span class="sd">    clevels : list of ints</span>
<span class="sd">        The neutral-quote-level for (&quot;,&quot;) pairs in the string.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    When using double-quotes, it is easy to break the parser, so they should be used only sparingly.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">alevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c1">## double-quote level</span>
    <span class="n">blevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c1">## single-quote level</span>
    <span class="n">clevels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c1">## neutral-quote level</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;`&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="c1">## Note: the &#39;\\&#39; case here is for detecting a grave accent markup.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;``&#39;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>       <span class="c1">## add a double-quote marker to the stack</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;`&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;()[]</span><span class="si">{}</span><span class="s1">&quot;:;,&lt;&gt;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="c1">## The trouble with single-quotes is the clash with apostrophes. So, only increment the single-quote</span>
                <span class="c1">## counter if we think it is the start of a quote (not immediately preceded by a non-whitespace</span>
                <span class="c1">## character).</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>       <span class="c1">## add a single-quote marker to the stack</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">blevels</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">clevels</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="c1">## Note: the &#39;\\&#39; case here is for detecting an accent markup.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c1">## remove double-quote marker from the stack</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c1">## remove single-quote marker from the stack</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="c1">## Note: the &#39;\\&#39; here case is for not detecting an umlaut markup.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c1">## remove neutral-quote marker from the stack</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

        <span class="n">alevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">blevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">clevels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 018a: found mismatched &quot;``&quot;...&quot;&#39;&#39;&quot; quote pairs in the input string &quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> \
             <span class="s1">&#39;&quot;. Ignoring the problem and continuing on ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="n">alevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 018b: found mismatched &quot;`&quot;...&quot;</span><span class="se">\&#39;</span><span class="s1">&quot; quote pairs in the input string &quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> \
             <span class="s1">&#39;&quot;. Ignoring the problem and continuing on ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="n">blevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 018c: found mismatched &quot;...&quot; quote pairs in the input string &quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> \
             <span class="s1">&#39;&quot;. Ignoring the problem and continuing on ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="n">clevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">alevels</span><span class="p">)</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">blevels</span><span class="p">)</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">clevels</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">alevels</span><span class="p">,</span> <span class="n">blevels</span><span class="p">,</span> <span class="n">clevels</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="splitat"><a class="viewcode-back" href="../bibulous.html#bibulous.splitat">[docs]</a><span class="k">def</span> <span class="nf">splitat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ilist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string at locations given by a list of indices.</span>

<span class="sd">    This can be used more flexibly than Python&#39;s native string split() function, when the character you are splitting on</span>
<span class="sd">    is not always a valid splitting location.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>
<span class="sd">    ilist : list</span>
<span class="sd">        The list of string index locations at which to split the string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slist : list of str</span>
<span class="sd">        The list of split substrings.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    s = splitat(&#39;here.but.not.here&#39;, [4,8])</span>
<span class="sd">    &gt;&gt;&gt; [&#39;here&#39;, &#39;but&#39;, &#39;not.here&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">numsplit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ilist</span><span class="p">)</span>
    <span class="n">slist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ilist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1">## If the function is being asked to &quot;split&quot; at the first character, then just truncate.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ilist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ilist</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">numsplit</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1">## If the function is being asked to &quot;split&quot; at the last character, then just truncate.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ilist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ilist</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">numsplit</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1">## If truncation has removed all of the &quot;splitting&quot; locations from the list, then return.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numsplit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">ilist</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ilist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ilist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ilist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsplit</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">ilist</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">slist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ilist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">slist</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="multisplit"><a class="viewcode-back" href="../bibulous.html#bibulous.multisplit">[docs]</a><span class="k">def</span> <span class="nf">multisplit</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seps</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string using more than one separator.</span>

<span class="sd">    Copied from http://stackoverflow.com/questions/1059559/python-strings-split-with-multiple-separators.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>
<span class="sd">    sep : list of str</span>
<span class="sd">        The list of separators.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res : list</span>
<span class="sd">        The list of split substrings.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">:</span>
        <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">seq</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="enwrap_nested_string"><a class="viewcode-back" href="../bibulous.html#bibulous.enwrap_nested_string">[docs]</a><span class="k">def</span> <span class="nf">enwrap_nested_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">),</span> <span class="n">odd_operator</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\textbf&#39;</span><span class="p">,</span> <span class="n">even_operator</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\textrm&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will return the input string if it finds there are no nested operators inside (i.e. when the number of</span>
<span class="sd">    delimiters found is &lt; 2).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string whose nested operators are to be modified.</span>
<span class="sd">    delims : tuple of two strings</span>
<span class="sd">        The left and right delimiters for all matches.</span>
<span class="sd">    odd_operator : str</span>
<span class="sd">        The nested operator (applied to the left of the delimiter) currently used within string &quot;s&quot;.</span>
<span class="sd">    even_operator : str</span>
<span class="sd">        The operator used to replace the currently used one for all even nesting levels.</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : str</span>
<span class="sd">        The modified string.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">odd_operator</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">oplevels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delims</span><span class="p">,</span> <span class="n">odd_operator</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">oplevels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 019: found mismatched &quot;{&quot;,&quot;}&quot; brace pairs in the input string. Ignoring the problem and&#39;</span>
             <span class="s1">&#39; continuing on ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1">## In the operator queue, we replace all even-numbered levels while leaving all odd-numbered levels alone. Recall</span>
    <span class="c1">## that &quot;oplevels&quot; encodes the position of the *delimiter* and not the position of where the operator starts.</span>
    <span class="n">maxlevels</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">oplevels</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">maxlevels</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1">## Select only even levels starting at 2. &quot;q&quot; is a counter for the number of substr replacements.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_operator</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">even_operator</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oplevels</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1">## Any place we see a transition from one level lower to this level is a substr we want to replace. The</span>
            <span class="c1">## &quot;shift&quot; used here is to compensate for changes in the length of the string due to differences in length</span>
            <span class="c1">## between the input operator and output.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">oplevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="c1">#print(i, level, oplevels[i-1], s, s[:i-len(odd_operator)], s[i:])</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">odd_operator</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">shift</span><span class="p">)]</span> <span class="o">+</span> <span class="n">even_operator</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">shift</span><span class="p">):]</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="enwrap_nested_quotes"><a class="viewcode-back" href="../bibulous.html#bibulous.enwrap_nested_quotes">[docs]</a><span class="k">def</span> <span class="nf">enwrap_nested_quotes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find nested quotes within strings and, if necessary, replace them with the proper nesting (i.e. outer quotes use</span>
<span class="sd">    ````...&#39;&#39;`` while inner quotes use ```...&#39;``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to modify.</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : str</span>
<span class="sd">        The new string in which nested quotes have been properly reformatted.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## NOTE: There is quite a lot going on in this function, so it may help future development to write some of this</span>
    <span class="c1">## work into subroutines.</span>

    <span class="c1">## First check for cases where parsing is going to be very complicated. For now, we should just flag these cases to</span>
    <span class="c1">## inform the user that they need to modify the source to tell the parser what they want to do.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;```&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 020: the input string [&quot;&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;&quot;] contains multiple unseparated quote characters.&#39;</span>
             <span class="s1">&#39; Bibulous cannot unnest the single and double quotes from this set, so the separate quotations must be &#39;</span>
             <span class="s1">&#39; physically separated like ``{\:}``, for example. Ignoring the quotation marks and continuing ...&#39;</span><span class="p">,</span>
             <span class="n">disable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1">## Note that a backtick preceded by a backslash, an explamation point, or a question mark, indicates LaTeX markup</span>
    <span class="c1">## for a grave accent, an inverted explamation point, and an inverted question mark, respectively.</span>
    <span class="c1">#adelims = (&#39;``&#39;,&quot;&#39;&#39;&quot;)</span>
    <span class="n">anum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!\!\?</span><span class="se">\\</span><span class="s1">)``&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="c1">#bdelims = (&#39;`&#39;,&quot;&#39;&quot;)</span>
    <span class="n">bnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!\!\?</span><span class="se">\\</span><span class="s1">)`&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="c1">#cdelim = &#39;&quot;&#39;</span>
    <span class="n">cnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)&quot;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">anum</span> <span class="o">+</span> <span class="n">bnum</span> <span class="o">+</span> <span class="n">cnum</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1">## Get the lists describing the quote nesting.</span>
    <span class="p">(</span><span class="n">alevels</span><span class="p">,</span> <span class="n">blevels</span><span class="p">,</span> <span class="n">clevels</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_quote_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

    <span class="c1">## First, we look at the quote stack and replace *all* quote pairs with \enquote{...}. When done, we can use</span>
    <span class="c1">## `enwrap_nested_string()` to replace the odd and even instances of \enquote{} with different quotation markers,</span>
    <span class="c1">## depending on locale. `q` is the amount of shift between indices in the current string and those in the source</span>
    <span class="c1">## string.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c1">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c1">## This is a transition down in level. Add &quot;}&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1">## Do the same thing for single quotes.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c1">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">blevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c1">## This is a transition down in level. Add &quot;}&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>

        <span class="c1">## Do the same thing for neutral quotes.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c1">## This is a transition up in level. Add &quot;\enquote{&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">clevels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="c1">## This is a transition down in level. Add &quot;}&quot;.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">:]</span>

    <span class="c1">## Next, we determine the nesting levels of quotations.</span>
    <span class="n">qlevels</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;\enquote&#39;</span><span class="p">)</span>

    <span class="c1">## Finally, replace odd levels of quotation with &quot;``&quot; and even levels with &quot;`&quot;. The approach taken below works for</span>
    <span class="c1">## the American convention. Need to generalize this behavior for British convention, and, even more broadly, to all</span>
    <span class="c1">## locale-dependent quotation mark behavior.</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">odd_operators</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;``&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
    <span class="n">even_operators</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;`&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">show_levels_debug</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">qlevels</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qlevels</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">continue</span>

        <span class="c1">## Any place we see a transition from one level lower to this level is a substr we want to replace. The shift</span>
        <span class="c1">## &quot;t&quot; used here is to compensate for changes in the length of the string due to differences in length between</span>
        <span class="c1">## the input operator and output. Also, if we are about to substitute in a quote character (or two, in the case</span>
        <span class="c1">## of LaTeX double quotes), then we need to be careful to look in front and see if the quotes butt up against</span>
        <span class="c1">## one another, in which case we need to add a small space. For example, LaTeX will interpret &#39;&#39;&#39; as a double</span>
        <span class="c1">## ending quote followed by a single ending quote, even ifwe meant it to be the other way around. The space</span>
        <span class="c1">## &quot;\:&quot; will remove the ambiguity.</span>

        <span class="c1">## There is quite a lot going on in this loop, so it may help future work to replace some of the operations</span>
        <span class="c1">## here with subroutines.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\:&#39;</span> <span class="o">+</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\:&#39;</span> <span class="o">+</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;r\enquote{&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\:&#39;</span> <span class="o">+</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\enquote{&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">qlevels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">left</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="n">left</span><span class="p">]</span> <span class="o">==</span> <span class="n">odd_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">needs_space</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">needs_space</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\:&#39;</span> <span class="o">+</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newstr</span> <span class="o">=</span> <span class="n">even_operators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">newstr</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">right</span><span class="p">:]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newstr</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="purify_string"><a class="viewcode-back" href="../bibulous.html#bibulous.purify_string">[docs]</a><span class="k">def</span> <span class="nf">purify_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Remove the LaTeX-based formatting elements from a string so that a sorting function can use alphanumerical sorting</span>
<span class="sd">    on the string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to &quot;purify&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p : str</span>
<span class="sd">        The &quot;purified&quot; string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">):</span>
        <span class="c1">## If there are no LaTeX commands, then just remove any braces present.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1">## If the string contains mathematical markup (i.e. $...$), then we have to treat that case specially, since we</span>
    <span class="c1">## don&#39;t want to run &quot;purify&quot; on mathematics --- it&#39;s not as easy as simply replacing math markup with unicode</span>
    <span class="c1">## equivalents. So, if we find math markup then we split the string into math parts and non-math parts, purify the</span>
    <span class="c1">## non-math ones, and then piece it back together. Messy.</span>
    <span class="n">mathpattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)\$.*?(?&lt;!</span><span class="se">\\</span><span class="s1">)\$&#39;</span><span class="p">)</span>
    <span class="n">matchobj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)\$.*?(?&lt;!</span><span class="se">\\</span><span class="s1">)\$&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">matchobj</span><span class="p">:</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">matchobj</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">mathpattern</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="n">start_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">end_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">end_idx</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">!=</span> <span class="s1">&#39;$&#39;</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">## Convert any LaTeX character encodings directly to their unicode equivalents.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">latex_to_utf8</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1">## Next we look for LaTeX commands. LaTeX variables will have the form &quot;\variable&quot; followed by either</span>
        <span class="c1">## whitespace, &#39;{&#39;, or &#39;}&#39;. A function will have the form &quot;\functionname{...}&quot; where the ellipsis can be</span>
        <span class="c1">## anything.</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">\w+&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="c1">## Finally, remove the braces used for LaTeX commands. We can&#39;t just replace &#39;{&#39; and &#39;}&#39; wholesale, since the</span>
        <span class="c1">## syntax allows &#39;\{&#39; and &#39;\}&#39; to produce text braces. So first we remove the command braces, and then we swap</span>
        <span class="c1">## &#39;\{&#39; for &#39;{&#39; etc at the end.</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">){&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)}&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">{&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">}&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="latex_to_utf8"><a class="viewcode-back" href="../bibulous.html#bibulous.latex_to_utf8">[docs]</a><span class="k">def</span> <span class="nf">latex_to_utf8</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Translate LaTeX-markup special characters to their Unicode equivalents.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to translate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s : str</span>
<span class="sd">        The translated version of the input.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## Note that the code below uses replace() loops rather than a translation table, since the latter only supports</span>
    <span class="c1">## one-to-one translation, whereas something more flexible is needed here.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1">## First, some easy replacements.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\$&#39;</span><span class="p">:</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\%&#39;</span><span class="p">:</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\_&#39;</span><span class="p">:</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\&amp;&#39;</span><span class="p">:</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\#&#39;</span><span class="p">:</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;!`&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;?`&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## If there are any double backslashes, place some braces around them to prevent something like &quot;\\aa&quot; from getting</span>
    <span class="c1">## interpreted as a backslash plus &quot;\aa&quot;. This makes the string easier to parse and does no harm.</span>
    <span class="k">if</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">}&#39;</span><span class="p">)</span>

    <span class="c1">## First identify all the LaTeX special characters in the string, then replace them all with their Unicode</span>
    <span class="c1">## equivalents. (This is to make sure that they alphabetize correctly for sorting.) The translation dictionary</span>
    <span class="c1">## below uses single-letter accent commands, such as \u{g}. These commands are one of (r&#39;\b&#39;, r&#39;\c&#39;, r&#39;\d&#39;, r&#39;\H&#39;,</span>
    <span class="c1">## r&#39;\k&#39;, r&#39;\r&#39;, r&#39;\u&#39;, r&#39;\v&#39;), followed by an open brace, a single character, and a closed brace. These</span>
    <span class="c1">## replacements are done first because some of the special characters use &#39;\i&#39;, which would otherwise get replaced</span>
    <span class="c1">## by the &quot;dotless i&quot; Unicode character, and so the replacement dictionary here would not detect the proper LaTeX</span>
    <span class="c1">## code for it.</span>

    <span class="c1">## First, characters with a cedilla or comma below.</span>
    <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\c&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c C}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c c}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c E}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c e}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{G}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c G}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{g}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c g}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{K}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c K}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{k}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c k}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{L}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c L}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{l}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c l}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{N}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c N}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{n}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c n}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{R}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c R}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{r}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c r}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{S}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c S}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c s}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{T}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c T}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\c</span><span class="si">{t}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\c t}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Characters with breve above. Note that the &quot;\u&quot; is problematic when using raw strings, so we use</span>
    <span class="c1">## double-backslashes instead.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u A}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u a}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u E}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u e}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{G}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u G}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{g}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u g}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u I}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u{\i}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u\i}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u O}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u o}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u U}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">u</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">u u}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Characters with an ogonek.</span>
    <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\k&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k A}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k a}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\k(E}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k E}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k e}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k I}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{i}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k i}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k O}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k o}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k U}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\k</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\k u}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Characters with hachek.</span>
    <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\v&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v C}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v c}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{D}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v D}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{d}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v d}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v E}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v e}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{L}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v L}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{l}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v l}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{N}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v N}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{n}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v n}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{R}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v R}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{r}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v r}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{S}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v S}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v s}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{T}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v T}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{t}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v t}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{Z}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v Z}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{z}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v z}&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{H}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u021E</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v H}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u021E</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{h}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u021F</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;{\v h}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u021F</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01CD</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v A}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01CD</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01CE</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;{\v a}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01CE</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01CF</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v I}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01CF</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v{\i}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D0</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v \i}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D0</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D1</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v O}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D1</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D2</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;{\v o}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D2</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D3</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v U}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D3</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;{\v u}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01D4</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{G}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E6</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v G}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E6</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{g}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E7</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;{\v g}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E7</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{K}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E8</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\v K}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E8</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\v</span><span class="si">{k}</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;{\v k}&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\u01E9</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\H&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\H</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\H</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\H</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\H</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\H O}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\H o}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="sa">r</span><span class="s1">&#39;{\H U}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\H u}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Characters with a ring above.</span>
    <span class="k">if</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\r&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\r</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\r U}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\r</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;{\r u}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Now let&#39;s do the straightforward accent characters.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\`A&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`a&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E0</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;A&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;a&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~A&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C3</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^a&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E2</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;A&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~a&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E3</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;a&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`E&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C8</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;E&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`e&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E8</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^E&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;e&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;E&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CB</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^e&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`I&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CC</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;e&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EB</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;I&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CD</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`\i&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EC</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^I&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CE</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;\i&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00ED</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\&quot;I&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CF</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^\i&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EE</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\~N&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D1</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\&quot;\i&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EF</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\`O&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D2</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~n&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;O&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D3</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`o&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F2</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^O&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;o&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F3</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~O&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D5</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^o&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;O&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D6</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\~o&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F5</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;o&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F6</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`U&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;U&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`u&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F9</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^U&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DB</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;u&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;U&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DC</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^u&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FB</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;Y&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DD</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\&quot;u&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FC</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;y&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FD</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FF</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=A&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0100</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=a&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0101</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;C&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0106</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;c&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0107</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^C&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0108</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^c&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0109</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.C&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u010A</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\.c&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u010B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=E&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0112</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=e&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0113</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.E&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0116</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.e&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0117</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^G&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u011C</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^g&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u011D</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.G&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0120</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.g&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0121</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^H&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0124</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^h&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0125</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~I&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0128</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~\i&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0129</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\=I&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u012A</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=\i&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u012B</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\.I&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0130</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^J&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0134</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^\j&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0135</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&#39;L&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0139</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;N&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0143</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;n&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0144</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=O&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u014C</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=o&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u014D</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;R&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0154</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;r&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0155</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;S&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u015A</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;s&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u015B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~U&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0168</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~u&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0169</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=U&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u016A</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\=u&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u016B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^W&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0174</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^w&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0175</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^Y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0176</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0177</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;Z&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0179</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;z&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u017A</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.Z&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u017B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.z&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u017C</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`Y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\`y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s2">&quot;\&#39;K&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s2">&quot;\&#39;k&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s2">&quot;\&#39;l&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\^A&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^S&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\^s&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\&quot;Y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\~E&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\~e&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\~Y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\~y&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Do again for anyone using extra braces.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E0</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{A}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{a}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C3</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E2</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E3</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C8</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{E}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00C9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E8</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00E9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CB</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CC</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EB</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{I}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CD</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`{\i}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EC</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CE</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;{\i}&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00ED</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00CF</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^{\i}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EE</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{N}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D1</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\&quot;{\i}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00EF</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D2</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{n}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F1</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{O}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D3</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F2</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{o}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F3</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D5</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F4</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D6</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F5</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F6</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00D9</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{U}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00F9</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DB</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{u}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FA</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DC</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FB</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{Y}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00DD</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FC</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{y}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FD</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00FF</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0100</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{a}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0101</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{C}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0106</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{c}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0107</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0108</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0109</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{C}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u010A</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{c}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u010B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0112</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0113</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0116</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0117</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{G}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u011C</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{g}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u011D</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{G}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0120</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{g}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0121</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{H}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0124</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{h}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0125</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0128</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~{\i}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0129</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u012A</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\={\i}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u012B</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{I}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0130</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{J}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0134</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^{\j}&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0135</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{L}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0139</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{N}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0143</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{n}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0144</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{O}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u014C</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{o}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u014D</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{R}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0154</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{r}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0155</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{S}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u015A</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{s}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u015B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0168</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0169</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{U}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u016A</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\=</span><span class="si">{u}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u016B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{W}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0174</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{w}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0175</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{Y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0176</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0177</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{Z}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u0179</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{z}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u017A</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{Z}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u017B</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\.</span><span class="si">{z}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u017C</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{Y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\`</span><span class="si">{y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{K}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s2">&quot;\&#39;</span><span class="si">{l}</span><span class="s2">&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{A}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{S}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\^</span><span class="si">{s}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\&quot;</span><span class="si">{Y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{E}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{Y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="sa">r</span><span class="s1">&#39;\~</span><span class="si">{y}</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="c1">## Those were easy. Next we look for single-char codes that must be followed by a non-alpha element, so that for</span>
    <span class="c1">## example \orange will produce the &quot;\orange&quot; LaTeX command while &quot;{\o}range&quot; or &quot;\o range&quot; will produce &quot;range&quot;.</span>
    <span class="c1">## Since we&#39;re using regex and not Python&#39;s string objects, we need to replace all backslashes with double-</span>
    <span class="c1">## backslashes. Thankfully, no other regex escape characters occur in this list of LaTeX markup for foreign letters.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="sa">r</span><span class="s1">&#39;\AA&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\AE&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\aa&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\ae&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\O&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\o&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\ss&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\i&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\L&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\l&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\OE&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\oe&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\j&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\P&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\S&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;\DH&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\dh&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\DJ&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\dj&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\IJ&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\ij&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\NG&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\ng&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\SS&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="sa">r</span><span class="s1">&#39;\TH&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\th&#39;</span><span class="p">:</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;(?!\w)&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<span class="k">def</span> <span class="nf">brace_split</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">):</span>

    <span class="c1">## If there are braces in the string, then we need to be careful to only allow splitting of the names when</span>
    <span class="c1">## &#39; and &#39; is at brace level 0. This requires replacing re.split() with a bunch of low-level code.</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">))</span>
    <span class="n">separators</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sep_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">splitter</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">sep_pattern</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1">## Record the indices of the start and end of the match.</span>
            <span class="n">separators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>

    <span class="n">num_splits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">separators</span><span class="p">)</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_splits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_splits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">separators</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">separators</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="c1">## Go through each match&#39;s indices and split the string at each.</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_splits</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">num_splits</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c1">## the end of *this* separator</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nexti</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>      <span class="c1">## the beginning of the *next* separator</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">separators</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>            <span class="c1">## the end of *this* separator</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">nexti</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">splits</span>

<span class="c1">## =============================</span>

<div class="viewcode-block" id="namestr_to_namedict"><a class="viewcode-back" href="../bibulous.html#bibulous.namestr_to_namedict">[docs]</a><span class="k">def</span> <span class="nf">namestr_to_namedict</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Take a BibTeX string representing a single person&#39;s name and parse it into its first, middle, last, etc pieces.</span>

<span class="sd">    BibTeX allows three different styles of author formats.</span>
<span class="sd">        (1) A space-separated list, [firstname middlenames suffix lastname]</span>
<span class="sd">        (2) A two-element comma-separated list, [prefix lastname, firstname middlenames]</span>
<span class="sd">        (3) a three-element comma-separated list, [prefix lastname, suffix, firstname middlenames].</span>
<span class="sd">    So, we can separate these three categories by counting the number of commas that appear.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namestr : str</span>
<span class="sd">        The string containing a single person&#39;s name, in BibTeX format</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        A dictionary with keys &quot;first&quot;, &quot;middle&quot;, &quot;prefix&quot;, &quot;last&quot;, and &quot;suffix&quot;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">namestr</span> <span class="o">=</span> <span class="n">namestr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1">## First we check to see if the namestr contains *only* a comma plus whitespace. This is definitely a format error</span>
    <span class="c1">## of some sort. Second, we check if the comma has whitespace to its right-hand side. If not, then it is likely a typo,</span>
    <span class="c1">## in which case issue a Warning but continue. If there is a valid comma within the string, then build the</span>
    <span class="c1">## delimiter level list so we can check whether the comma is at delimiter level 0 (and therefore a valid comma</span>
    <span class="c1">## for determining name structure). Using this, determine the locations of &quot;valid&quot; commas.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">namestr</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">namestr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 038: A name in the bibliography file contains only a lone comma, and so is a typo. Skipping ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
            <span class="k">return</span><span class="p">({})</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">))</span>
        <span class="n">commapos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">namestr</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namestr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">namestr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">namestr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 037: A comma appears within the name string &quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; and has no whitespace following it, and so is likely a typo. Ignoring ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">commapos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">commapos</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">## Note: switch on &quot;len(commapos)&quot; here rather than on &quot;(&#39;,&#39; not in namestr)&quot; because the latter will produce an</span>
    <span class="c1">## error when the comma occurs at brace levels other than zero.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1">## Allow nametokens to be split by spaces *or* word ties (&#39;~&#39; == unbreakable spaces), except when the &#39;~&#39; is</span>
        <span class="c1">## preceded by a backslash, in which case we have the LaTeX markup for the tilde accent. We use &quot;stringsplit()&quot;</span>
        <span class="c1">## rather than the standard string object&#39;s &quot;split()&quot; function because we don&#39;t want the split to be applied</span>
        <span class="c1">## when the separator is not at brace level zero.</span>
        <span class="n">nametokens</span> <span class="o">=</span> <span class="n">stringsplit</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; |(?&lt;!</span><span class="se">\\</span><span class="s1">)~&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nametokens</span><span class="p">:</span>
            <span class="n">n_temp</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">## If we find a dot which is not preceded by a backslash and not succeeded by a dash. Also, we shouldn&#39;t</span>
            <span class="c1">## care about dots appearing within curle braces, so we have to check for that as well.</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">get_delim_levels</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)\.(?!-)&#39;</span><span class="p">,</span> <span class="n">n_temp</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">namestr</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;)&#39;</span><span class="p">):</span>
                    <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 021: The name token &quot;&#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="s1">&#39;&quot; in namestring &quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> \
                         <span class="s1">&#39;&quot; has a &quot;.&quot; inside it, which may be a typo. Ignoring ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>

        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nametokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">first_nametokens</span> <span class="o">=</span> <span class="n">brace_split</span><span class="p">(</span><span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">second_nametokens</span> <span class="o">=</span> <span class="n">brace_split</span><span class="p">(</span><span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">second_nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">second_nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">,</span> <span class="n">thirdpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">first_nametokens</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">second_nametokens</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">third_nametokens</span> <span class="o">=</span> <span class="n">thirdpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">second_nametokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 022: the BibTeX format for namestr=&quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed.</span><span class="se">\n</span><span class="s1">There should &#39;</span> <span class="o">+</span> \
                 <span class="s1">&#39;be only one name in the second part of the three comma-separated name elements.&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
            <span class="k">return</span><span class="p">({</span><span class="s1">&#39;last&#39;</span><span class="p">:</span><span class="s1">&#39;???&#39;</span><span class="p">})</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_nametokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">third_nametokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">third_nametokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">third_nametokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="c1">#if (len(namedict[&#39;middle&#39;]) == 1):</span>
            <span class="c1">#    namedict[&#39;middle&#39;] = namedict[&#39;middle&#39;][0]</span>
            <span class="n">namedict</span> <span class="o">=</span> <span class="n">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="c1">## The name format is (first,middle,prefix,last).</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">,</span> <span class="n">thirdpart</span><span class="p">,</span> <span class="n">fourthpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thirdpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourthpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1">#namedict[&#39;suffix&#39;] =</span>

    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commapos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
        <span class="c1">## The name format is (first,middle,prefix,last,suffix).</span>
        <span class="n">namedict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">(</span><span class="n">firstpart</span><span class="p">,</span> <span class="n">secondpart</span><span class="p">,</span> <span class="n">thirdpart</span><span class="p">,</span> <span class="n">fourthpart</span><span class="p">,</span> <span class="n">fifthpart</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">namestr</span><span class="p">,</span> <span class="n">commapos</span><span class="p">)</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thirdpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourthpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifthpart</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 023: the BibTeX format for namestr=&quot;&#39;</span> <span class="o">+</span> <span class="n">namestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed.</span><span class="se">\n</span><span class="s1">There should &#39;</span> <span class="o">+</span> \
             <span class="s1">&#39;never be more than four commas in a given name.&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">({</span><span class="s1">&#39;last&#39;</span><span class="p">:</span><span class="s1">&#39;???&#39;</span><span class="p">})</span>

    <span class="c1">## If any tokens in the middle name start with lower case, then move them, and any tokens after them, to the prefix.</span>
    <span class="c1">## An important difference is that prefixes typically don&#39;t get converted to initials when generating the formatted</span>
    <span class="c1">## bibliography string.</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;middle&#39;</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">nametokens</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nametokens</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">nametokens</span><span class="p">]</span>
        <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nametokens</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">move</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">movelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">removelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span> <span class="n">move</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">move</span><span class="p">:</span>
                <span class="n">movelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">removelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1">## Add the tokens to the prefix and remove them from the middle name.</span>
        <span class="k">if</span> <span class="n">movelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">):</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">movetokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">movelist</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">movetokens</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">removelist</span><span class="p">:</span>
            <span class="n">nametokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">removelist</span><span class="p">]</span>
            <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nametokens</span><span class="p">)</span>

    <span class="c1">## Finally, go through and remove any name elements that are blank. Use &quot;key in list(namedict)&quot; rather than</span>
    <span class="c1">## &quot;key in namedict&quot; here because we want to be able to change the dictionary in the loop.</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">namedict</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">namedict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">namedict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="search_middlename_for_prefixes"><a class="viewcode-back" href="../bibulous.html#bibulous.search_middlename_for_prefixes">[docs]</a><span class="k">def</span> <span class="nf">search_middlename_for_prefixes</span><span class="p">(</span><span class="n">namedict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    From the middle name of a single person, check if any of the names should be placed into the &quot;prefix&quot; and move them</span>
<span class="sd">    there.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        The dictionary containing the key &quot;middle&quot;, containing the string with the person&#39;s middle names/initials.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        The dictionary augmented with the key &quot;prefix&quot; if a prefix is indeed found.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;middle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span>

    <span class="c1">## Search the list of middle names from the back to the front. If the name encountered starts with lower case, then</span>
    <span class="c1">## it is moved to namedict[&#39;prefix&#39;]. If not, then stop the search and break out of the loop.</span>
    <span class="n">middlenames</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">middlenames</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
            <span class="n">prefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">middlenames</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">middlenames</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namedict</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="get_edition_ordinal"><a class="viewcode-back" href="../bibulous.html#bibulous.get_edition_ordinal">[docs]</a><span class="k">def</span> <span class="nf">get_edition_ordinal</span><span class="p">(</span><span class="n">edition_field</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a bibliography entry&#39;s edition *number*, format it as an ordinal (i.e. &quot;1st&quot;, &quot;2nd&quot; instead of &quot;1&quot;, &quot;2&quot;) in</span>
<span class="sd">    the way that it will appear on the formatted page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edition_field : str</span>
<span class="sd">        The string representing the &quot;edition&quot; field in the database entry.</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    edition_ordinal_str : str</span>
<span class="sd">        The formatted form of the edition, with ordinal attached.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## First check that the field exists.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">edition_field</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">edition_field</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span><span class="p">(</span><span class="n">edition_field</span><span class="p">)</span>

    <span class="n">trans</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;first&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">:</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;third&#39;</span><span class="p">:</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;fourth&#39;</span><span class="p">:</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;fifth&#39;</span><span class="p">:</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;sixth&#39;</span><span class="p">:</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;seventh&#39;</span><span class="p">:</span><span class="s1">&#39;7&#39;</span><span class="p">,</span>
             <span class="s1">&#39;eighth&#39;</span><span class="p">:</span><span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;ninth&#39;</span><span class="p">:</span><span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;tenth&#39;</span><span class="p">:</span><span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;eleventh&#39;</span><span class="p">:</span><span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;twelfth&#39;</span><span class="p">:</span><span class="s1">&#39;12&#39;</span><span class="p">,</span> <span class="s1">&#39;thirteenth&#39;</span><span class="p">:</span><span class="s1">&#39;13&#39;</span><span class="p">,</span>
             <span class="s1">&#39;fourteenth&#39;</span><span class="p">:</span><span class="s1">&#39;14&#39;</span><span class="p">,</span> <span class="s1">&#39;fifteenth&#39;</span><span class="p">:</span><span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;sixteenth&#39;</span><span class="p">:</span><span class="s1">&#39;16&#39;</span><span class="p">,</span> <span class="s1">&#39;seventeenth&#39;</span><span class="p">:</span><span class="s1">&#39;17&#39;</span><span class="p">,</span> <span class="s1">&#39;eighteenth&#39;</span><span class="p">:</span><span class="s1">&#39;18&#39;</span><span class="p">,</span>
             <span class="s1">&#39;nineteenth&#39;</span><span class="p">:</span><span class="s1">&#39;19&#39;</span><span class="p">,</span> <span class="s1">&#39;twentieth&#39;</span><span class="p">:</span><span class="s1">&#39;20&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">edition_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">:</span>
        <span class="n">edition_field</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="n">edition_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="c1">## Add the ordinal string to the number.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">edition_field</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 024: an edition number of &quot;0&quot; is invalid. Cannot create ordinal.&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">edition_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">edition_field</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
        <span class="n">edition_ordinal_str</span> <span class="o">=</span> <span class="s1">&#39;1st&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">edition_field</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">):</span>
        <span class="n">edition_ordinal_str</span> <span class="o">=</span> <span class="s1">&#39;2nd&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">edition_field</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
        <span class="n">edition_ordinal_str</span> <span class="o">=</span> <span class="s1">&#39;3rd&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">edition_field</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">edition_ordinal_str</span> <span class="o">=</span> <span class="n">edition_field</span> <span class="o">+</span> <span class="s1">&#39;th&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">## I&#39;m not sure whether the code can reach this point, but just in case.</span>
        <span class="n">edition_ordinal_str</span> <span class="o">=</span> <span class="n">edition_field</span>

    <span class="k">return</span><span class="p">(</span><span class="n">edition_ordinal_str</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="export_bibfile"><a class="viewcode-back" href="../bibulous.html#bibulous.export_bibfile">[docs]</a><span class="k">def</span> <span class="nf">export_bibfile</span><span class="p">(</span><span class="n">bibdata</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">abbrevs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write a bibliography database dictionary into a .bib file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The filename of the file to write.</span>
<span class="sd">    bibdata : dict</span>
<span class="sd">        The bibliography dictionary to write out.</span>
<span class="sd">    abbrevs : dict, optional</span>
<span class="sd">        The dictionary of abbreviations to write to the BIB file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s1">&#39;Input &quot;filename&quot; must be a string.&#39;</span>
    <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;preamble&#39;</span> <span class="ow">in</span> <span class="n">bibdata</span><span class="p">):</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bibdata</span><span class="p">[</span><span class="s1">&#39;preamble&#39;</span><span class="p">])</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">abbrevs</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">abbrev</span> <span class="ow">in</span> <span class="n">abbrevs</span><span class="p">:</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;@STRING{&#39;</span> <span class="o">+</span> <span class="n">abbrev</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">abbrevs</span><span class="p">[</span><span class="n">abbrev</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bibdata</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;preamble&#39;</span><span class="p">):</span> <span class="k">continue</span>

        <span class="c1">## Since you&#39;re about to delete an item from the &quot;entry&quot; dictionary, and it is a view into the main database</span>
        <span class="c1">## dictionary, you need to make a deep copy of it first before deleteing or else it will delete the entry from</span>
        <span class="c1">## the main database as well!</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bibdata</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;entrytype&#39;</span><span class="p">]</span>
        <span class="n">nkeys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="c1">## Write out the entries.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39; = {&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>

            <span class="c1">## If this is the last field in the dictionary, then do not end the line with a trailing comma.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">nkeys</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="parse_pagerange"><a class="viewcode-back" href="../bibulous.html#bibulous.parse_pagerange">[docs]</a><span class="k">def</span> <span class="nf">parse_pagerange</span><span class="p">(</span><span class="n">pages_str</span><span class="p">,</span> <span class="n">citekey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a string containing the &quot;pages&quot; field of a bibliographic entry, figure out the start and end pages.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pages_str : str</span>
<span class="sd">        The string to parse.</span>
<span class="sd">    citekey : str, optional</span>
<span class="sd">        The citation key (useful for debugging messages).</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers to ignore.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    startpage : str</span>
<span class="sd">        The starting page.</span>
<span class="sd">    endpage : str</span>
<span class="sd">        The ending page. If endpage==startpage, then endpage is set to None.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pages_str</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1">## Note that we work with strings instead of integers, because the use of letters in article pages is common</span>
    <span class="c1">## (e.g. page &quot;D5&quot;).</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">pages_str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">pages_str</span><span class="p">):</span>
        <span class="n">pagesplit</span> <span class="o">=</span> <span class="n">multisplit</span><span class="p">(</span><span class="n">pages_str</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="n">startpage</span> <span class="o">=</span> <span class="n">pagesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">endpage</span> <span class="o">=</span> <span class="n">pagesplit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">endpage</span> <span class="o">==</span> <span class="n">startpage</span><span class="p">):</span> <span class="n">endpage</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">startpage</span> <span class="o">=</span> <span class="n">pages_str</span>
        <span class="n">endpage</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">## For user convenience, add a check here that if endpage and startpage are both numbers and endpage &lt;= startpage,</span>
    <span class="c1">## then there is a typo.</span>
    <span class="k">if</span> <span class="n">startpage</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">endpage</span> <span class="ow">and</span> <span class="n">endpage</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">endpage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">startpage</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">citekey</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 025a: the &quot;pages&quot; field in entry &quot;&#39;</span> <span class="o">+</span> <span class="n">citekey</span> <span class="o">+</span> <span class="s1">&#39;&quot; has a malformed page range &#39;</span>
                     <span class="s1">&#39;(endpage &lt; startpage). Ignoring ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bib_warning</span><span class="p">(</span><span class="s1">&#39;Warning 025b: the &quot;pages&quot; field &quot;&#39;</span> <span class="o">+</span> <span class="n">pages_str</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed, since endpage &lt; &#39;</span>
                     <span class="s1">&#39;startpage. Ignoring ...&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">startpage</span><span class="p">,</span> <span class="n">endpage</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="parse_nameabbrev"><a class="viewcode-back" href="../bibulous.html#bibulous.parse_nameabbrev">[docs]</a><span class="k">def</span> <span class="nf">parse_nameabbrev</span><span class="p">(</span><span class="n">abbrevstr</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a string containing either a single &quot;name&quot; &gt; &quot;abbreviation&quot; pair or a list of such pairs, parse the string</span>
<span class="sd">    into a dictionary of names and abbreviations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    abbrevstr : str</span>
<span class="sd">        The string containing the abbreviation definitions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nameabbrev_dict : dict</span>
<span class="sd">        A dictionary with names for keys and abbreviations for values.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">nameabbrev_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">abbrevlist</span> <span class="o">=</span> <span class="n">abbrevstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">abbrevlist</span><span class="p">:</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &gt; &#39;</span><span class="p">)</span>
        <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">nameabbrev_dict</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">nameabbrev_dict</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="filter_script"><a class="viewcode-back" href="../bibulous.html#bibulous.filter_script">[docs]</a><span class="k">def</span> <span class="nf">filter_script</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Remove elements from a Python script which are provide the most egregious security flaws; also replace some</span>
<span class="sd">    identifiers with their correct namespace representation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    line : str</span>
<span class="sd">        The line of source code to filter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filtered : str</span>
<span class="sd">        The filtered line of source code.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">os_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\Wos.&#39;</span><span class="p">)</span>
    <span class="n">sys_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\Wsys.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;import&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">os_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sys_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">line</span>

    <span class="c1">## Replace any use of &quot;entry&quot;, &quot;options&quot;, &quot;citedict&quot;, or &quot;bstdict&quot; with the needed identifier</span>
    <span class="c1">## for the namespace inside format_bibitem().</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=\W)entry(?=\W)&#39;</span><span class="p">,</span> <span class="s1">&#39;self.bibdata[c]&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=\W)options(?=\W)&#39;</span><span class="p">,</span> <span class="s1">&#39;self.options&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=\W)citedict(?=\W)&#39;</span><span class="p">,</span> <span class="s1">&#39;self.citedict&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=\W)bstdict(?=\W)&#39;</span><span class="p">,</span> <span class="s1">&#39;self.bstdict&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="str_is_integer"><a class="viewcode-back" href="../bibulous.html#bibulous.str_is_integer">[docs]</a><span class="k">def</span> <span class="nf">str_is_integer</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check is an input string represents an integer value. Although a trivial function, it will be useful for user</span>
<span class="sd">    scripts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The input string to test.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    is_integer : bool</span>
<span class="sd">        Whether the string represents an integer value.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="bib_warning"><a class="viewcode-back" href="../bibulous.html#bibulous.bib_warning">[docs]</a><span class="k">def</span> <span class="nf">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Print a warning message, with the option to disable any given message.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg : str</span>
<span class="sd">        The warning message to print.</span>
<span class="sd">    disable : list of int, optional</span>
<span class="sd">        The list of warning message numbers that the user wishes to disable (i.e. ignore).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">disable</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1">## For each number in the &quot;ignore&quot; list, find out if the warning message is one of the ones to ignore. If so, then</span>
    <span class="c1">## do nothing.</span>
    <span class="n">show_warning</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">disable</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Warning </span><span class="si">%03i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">show_warning</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">show_warning</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="create_citation_alpha"><a class="viewcode-back" href="../bibulous.html#bibulous.create_citation_alpha">[docs]</a><span class="k">def</span> <span class="nf">create_citation_alpha</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an &quot;alpha&quot; style citation key (typically the first three letters of the author&#39;s last name, followed by the</span>
<span class="sd">    last two numbers of the year).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    entry : dict</span>
<span class="sd">        The bibliography entry.</span>
<span class="sd">    options : dict</span>
<span class="sd">        The dictionary of keyword options (the only key used is &quot;name_separator&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alpha : str</span>
<span class="sd">        The alpha-style citation key.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;authorlist&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;authorlist&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;editorlist&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;editorlist&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;author&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;editor&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;organization&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;organization&#39;</span><span class="p">]</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="n">org</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;institution&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span>
        <span class="n">namelist</span> <span class="o">=</span> <span class="n">namefield_to_namelist</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;name_separator&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;UNDEFINED&#39;</span><span class="p">)</span>

    <span class="c1">## Note: you need to run &quot;purify&quot; before extracting the first three letters, because the first character might be a</span>
    <span class="c1">## curly brace that purify can get rid of, or the first three characters might be something like &quot;\AA&quot; which should</span>
    <span class="c1">## be extracted as a single unicode character.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">concat_name</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">concat_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">:</span>
            <span class="n">concat_name</span> <span class="o">+=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;??&#39;</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">concat_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">year</span>

    <span class="k">return</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="toplevel_split"><a class="viewcode-back" href="../bibulous.html#bibulous.toplevel_split">[docs]</a><span class="k">def</span> <span class="nf">toplevel_split</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">splitchar</span><span class="p">,</span> <span class="n">levels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split a string, but only if the splitting character is at level 0 or 1 and not higher.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        The string to split.</span>
<span class="sd">    splitchar : str</span>
<span class="sd">        The character to split with.</span>
<span class="sd">    levels : list of ints</span>
<span class="sd">        The operator levels of the characters in the string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    split_list : list of str</span>
<span class="sd">        The list of split sections of the string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## Make a complete list of indices where we can find the splitting character. Ignore those locations at operator</span>
    <span class="c1">## levels of 2 or higher.</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">splitchar</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">split_list</span> <span class="o">=</span> <span class="n">splitat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">split_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">split_list</span><span class="p">)</span></div>

<span class="c1">## ===================================</span>
<div class="viewcode-block" id="get_variable_name_elements"><a class="viewcode-back" href="../bibulous.html#bibulous.get_variable_name_elements">[docs]</a><span class="k">def</span> <span class="nf">get_variable_name_elements</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Split the variable name into &quot;name&quot; (left-hand-side part), &quot;iterator&quot; (middle part), and &quot;remainder&quot; (the right-</span>
<span class="sd">    hand-side part).</span>

<span class="sd">    With these three elements, we will know how to build a template variable inside the implicit loop.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    variable : str</span>
<span class="sd">        The variable name to be parsed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    var_dict : dict</span>
<span class="sd">        The dictionary containing elements of the variable name, with keys &#39;varname&#39;, &#39;prefix&#39;, &#39;index&#39;, and &#39;suffix&#39;. \</span>
<span class="sd">        The input variable can be reconstructed with name + &#39;.&#39; + prefix + index + suffix.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">varlist</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">var_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">piece</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">piece</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">piece</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">piece</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
            <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">piece</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">piece</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_dict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">piece</span>

    <span class="k">return</span><span class="p">(</span><span class="n">var_dict</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="format_namelist"><a class="viewcode-back" href="../bibulous.html#bibulous.format_namelist">[docs]</a><span class="k">def</span> <span class="nf">format_namelist</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span> <span class="n">nametype</span><span class="o">=</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Format a list of dictionaries (one dict for each person) into a long string, with the format according to the</span>
<span class="sd">    directives in the bibliography style template.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namelist : str</span>
<span class="sd">        The list of dictionaries containing all of the names to be formatted.</span>
<span class="sd">    nametype : str, {&#39;author&#39;, &#39;editor&#39;}, optional</span>
<span class="sd">        Whether the names are for authors or editors.</span>
<span class="sd">    options : dict, optional</span>
<span class="sd">        The dictionary of keyword-based options.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namestr : str</span>
<span class="sd">        The formatted form of the &quot;name string&quot;. This is generally a list of authors or list of editors.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;use_firstname_initials&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_firstname_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;namelist_format&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;namelist_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first_name_first&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;maxauthors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;minauthors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;minauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;maxeditors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxeditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mineditors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mineditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;etal_message&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;etal_message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textit{et al.}&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;use_name_ties&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_name_ties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;terse_inits&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;terse_inits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;french_intials&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_intials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;period_after_initial&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">## First get all of the options variables needed below, depending on whether the function is operating on a list of</span>
    <span class="c1">## authors or a list of editors. Second, insert &quot;authorlist&quot; into the bibliography database entry so that other</span>
    <span class="c1">## functions can have access to it. (This is the &quot;author&quot; or &quot;editor&quot; string parsed into individual names, so that</span>
    <span class="c1">## each person&#39;s name is represented by a dictionary, and the whole set of names is a list of dicts.)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nametype</span> <span class="o">==</span> <span class="s1">&#39;author&#39;</span><span class="p">):</span>
        <span class="n">maxnames</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxauthors&#39;</span><span class="p">]</span>
        <span class="n">minnames</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;minauthors&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nametype</span> <span class="o">==</span> <span class="s1">&#39;editor&#39;</span><span class="p">):</span>
        <span class="n">maxnames</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxeditors&#39;</span><span class="p">]</span>
        <span class="n">minnames</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mineditors&#39;</span><span class="p">]</span>

    <span class="c1">## It makes no sense for the &quot;minnames&quot; to be equal to or larger than the &quot;maxnames&quot; -- an issue which can easily</span>
    <span class="c1">## happen if a user specifies the &quot;maxnames&quot; option keyword but leaves the &quot;minnames&quot; keyword as a default. In this</span>
    <span class="c1">## case, we need to fix the minnames value.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minnames</span> <span class="o">&gt;</span> <span class="n">maxnames</span><span class="p">):</span>
        <span class="n">minnames</span> <span class="o">=</span> <span class="n">maxnames</span>

    <span class="c1">## This next block generates the list &quot;namelist&quot;, which is a list of strings, with each element of `namelist` being</span>
    <span class="c1">## a single author&#39;s name. That single author&#39;s name is encoded as a dictionary with keys &quot;first&quot;, &quot;middle&quot;,</span>
    <span class="c1">## &quot;prefix&quot;, &quot;last&quot;, and &quot;suffix&quot;.</span>
    <span class="n">npersons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">namelist</span><span class="p">)</span>
    <span class="n">new_namelist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">:</span>
        <span class="c1">## The BibTeX standard states that a final author in the authors field of &quot;and others&quot; should be taken as</span>
        <span class="c1">## meaning to use \textit{et al.} at the end of the author list.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;others&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;first&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">person</span><span class="p">):</span>
            <span class="n">npersons</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">maxnames</span> <span class="o">=</span> <span class="n">npersons</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1">## From the person&#39;s name dictionary, create a string of the name in the format desired for the final BBL file.</span>
        <span class="n">formatted_name</span> <span class="o">=</span> <span class="n">namedict_to_formatted_namestr</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="n">new_namelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_name</span><span class="p">)</span>

    <span class="c1">## Now that we have the complete list of pre-formatted names, we need to join them together into a single string</span>
    <span class="c1">## that can be inserted into the template.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">new_namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_namelist</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">&lt;=</span> <span class="n">maxnames</span><span class="p">):</span>
        <span class="c1">## Make a string in which each person&#39;s name is separated by a comma, except the last name, which has a comma</span>
        <span class="c1">## then &quot;and&quot; before the name.</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_namelist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, and &#39;</span> <span class="o">+</span> <span class="n">new_namelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">&gt;</span> <span class="n">maxnames</span><span class="p">):</span>
        <span class="c1">## If the number of names in the list exceeds the maximum, then truncate the list to the first &quot;minnames&quot; only,</span>
        <span class="c1">## and add &quot;et al.&quot; to the end of the string giving all the names.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">minnames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="n">new_namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;etal_message&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_namelist</span><span class="p">[:</span><span class="n">minnames</span><span class="p">])</span> <span class="o">+</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;etal_message&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;How did you get here?&#39;</span><span class="p">)</span>

    <span class="c1">## Add a tag onto the end if describing an editorlist.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nametype</span> <span class="o">==</span> <span class="s1">&#39;editor&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npersons</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">edmsg</span> <span class="o">=</span> <span class="s1">&#39;, ed.&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;edmsg1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span> <span class="k">else</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;edmsg1&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edmsg</span> <span class="o">=</span> <span class="s1">&#39;, eds&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;edmsg2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span> <span class="k">else</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;edmsg2&#39;</span><span class="p">]</span>
        <span class="n">namestr</span> <span class="o">+=</span> <span class="n">edmsg</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namestr</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="namedict_to_formatted_namestr"><a class="viewcode-back" href="../bibulous.html#bibulous.namedict_to_formatted_namestr">[docs]</a><span class="k">def</span> <span class="nf">namedict_to_formatted_namestr</span><span class="p">(</span><span class="n">namedict</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a name dictionary into a formatted name string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    namedict : dict</span>
<span class="sd">        The name dictionary (contains a required key &quot;last&quot; and optional keys &quot;first&quot;, &quot;middle&quot;, &quot;prefix&quot;, and &quot;suffix&quot;.</span>
<span class="sd">    options : dict, optional</span>
<span class="sd">        Dictionary of formatting options.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    namestr : str</span>
<span class="sd">        The formatted string of the name.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;use_firstname_initials&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_firstname_initials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;namelist_format&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;namelist_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first_name_first&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;maxauthors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;minauthors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;minauthors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;maxeditors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;maxeditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mineditors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mineditors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;etal_message&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;etal_message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textit{et al.}&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;use_name_ties&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_name_ties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;terse_inits&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;terse_inits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;french_intials&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;french_intials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;period_after_initial&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>  <span class="n">options</span><span class="p">[</span><span class="s1">&#39;period_after_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">lastname</span> <span class="o">=</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;first&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span>
    <span class="n">middlename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;middle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;suffix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">namedict</span><span class="p">)</span> <span class="k">else</span> <span class="n">namedict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_firstname_initials&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">firstname</span><span class="p">:</span>
            <span class="n">firstname</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">firstname</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">middlename</span> <span class="o">=</span> <span class="n">initialize_name</span><span class="p">(</span><span class="n">middlename</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">middlename</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;terse_inits&#39;</span><span class="p">]:</span>
            <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span> <span class="o">+</span> <span class="n">middlename</span>
            <span class="n">frontname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;use_name_ties&#39;</span><span class="p">]:</span>
            <span class="n">middlename</span> <span class="o">=</span> <span class="n">middlename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>    <span class="c1">## replace spaces with tildes</span>
            <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="n">middlename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">middlename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frontname</span> <span class="o">=</span> <span class="n">firstname</span>

    <span class="c1">## Reconstruct the name string in the desired order for the formatted bibliography.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;namelist_format&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;first_name_first&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">prefix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">frontname</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>    <span class="c1">## provide a space before last name</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">frontname</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">lastname</span> <span class="o">+</span> <span class="n">suffix</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;namelist_format&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;last_name_first&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="c1">## Provide a comma before the first name.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">frontname</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">frontname</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">frontname</span>
        <span class="n">namestr</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">lastname</span> <span class="o">+</span> <span class="n">frontname</span> <span class="o">+</span> <span class="n">suffix</span>

    <span class="k">return</span><span class="p">(</span><span class="n">namestr</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="argsort"><a class="viewcode-back" href="../bibulous.html#bibulous.argsort">[docs]</a><span class="k">def</span> <span class="nf">argsort</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the indices for producing a sorted list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seq : iterable</span>
<span class="sd">        The iterable object to sort.</span>
<span class="sd">    reverse : bool</span>
<span class="sd">        Whether to return a reversed list.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    idx : list of ints</span>
<span class="sd">        The indices needed for a sorted list.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">seq</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="create_alphanum_citelabels"><a class="viewcode-back" href="../bibulous.html#bibulous.create_alphanum_citelabels">[docs]</a><span class="k">def</span> <span class="nf">create_alphanum_citelabels</span><span class="p">(</span><span class="n">entrykey</span><span class="p">,</span> <span class="n">bibdata</span><span class="p">,</span> <span class="n">citelist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an alphanumeric style citation key (the first letter of the author&#39;s last name, followed by a number giving</span>
<span class="sd">    the sort order).</span>

<span class="sd">    Warning: do *not* run this function on a large database of citations --- it is not optimized for that use and will</span>
<span class="sd">    take quite a while to complete.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    entry : dict</span>
<span class="sd">        The bibliography entry.</span>
<span class="sd">    bibdata : dict</span>
<span class="sd">        The entire bibliography database.</span>
<span class="sd">    citelist : list of str</span>
<span class="sd">        The sorted list of citation keys.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    citelabels : str</span>
<span class="sd">        The dictionary of citation labels.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">citelabels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">alphanums</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citelist</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;authorlist&#39;</span> <span class="ow">in</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
            <span class="n">namelist</span> <span class="o">=</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;authorlist&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;editorlist&#39;</span> <span class="ow">in</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
            <span class="n">namelist</span> <span class="o">=</span> <span class="n">bibdata</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;editorlist&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1">## Note: you need to run &quot;purify&quot; before extracting the name, because the first character might be a</span>
        <span class="c1">## curly brace that purify can get rid of, or the &quot;first letter&quot; be something like &quot;\AA&quot; that ought to</span>
        <span class="c1">## be extracted as a single unicode character.</span>
        <span class="n">letter</span> <span class="o">=</span> <span class="n">purify_string</span><span class="p">(</span><span class="n">namelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">letter</span><span class="o">+</span><span class="s1">&#39;1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alphanums</span><span class="p">):</span>
            <span class="n">citelabels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">letter</span><span class="o">+</span><span class="s1">&#39;1&#39;</span>
            <span class="n">alphanums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">letter</span><span class="o">+</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="c1">#print(&#39;[%s]: %s&#39; % (c, letter+&#39;1&#39;))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">letter</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="ow">in</span> <span class="n">alphanums</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">citelabels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">letter</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">alphanums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">letter</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
            <span class="c1">#print(&#39;[%s]: %s&#39; % (c, letter+str(q)))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">citelabels</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<div class="viewcode-block" id="get_implicit_loop_data"><a class="viewcode-back" href="../bibulous.html#bibulous.get_implicit_loop_data">[docs]</a><span class="k">def</span> <span class="nf">get_implicit_loop_data</span><span class="p">(</span><span class="n">templatestr</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    From a template containing an implicit loop (&#39;...&#39; notation), build a full-size template without an ellipsis.</span>

<span class="sd">    Right now, the code only allows one implicit loop in any given template.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    templatestr : str</span>
<span class="sd">        The input template string (containing the implicit loop ellipsis notation).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loop_data : dict</span>
<span class="sd">        A dictionary containing all of the information needed to build a loop for a template.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">templatestr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
    <span class="n">lhs</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="n">templatestr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">:]</span>

    <span class="c1">## In the string to the left of the ellipsis, look for the template variable farthest to the right. Note that</span>
    <span class="c1">## we can&#39;t just set &quot;lhs_var = lhs_variables[-1]&quot; because we need to know the *position* of the variable and</span>
    <span class="c1">## not just the variable name. And if the name occurs more than once in the template, then we can&#39;t easily get</span>
    <span class="c1">## the position from the name. Thus, we iterate through the string until we encounter the last match, and</span>
    <span class="c1">## return that.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">lhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 030a: the template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed. It does not have a &#39;</span> <span class="o">+</span> \
              <span class="s1">&#39;template variable to the left of the ellipsis (implied loop).&#39;</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">lhs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 030b: the template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed. Only one variable is allowed &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;but the template has more than one.&#39;</span>
            <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">lhs_span</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
    <span class="n">lhs_var</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>

    <span class="c1">## Get the part of the template that goes before the implicit loop.</span>
    <span class="n">before_loop_stuff</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">[:</span><span class="n">lhs_span</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1">## &quot;get_variable_name_elements()&quot; returns a dictionary with keys &quot;index&quot;, &quot;name&quot;, &quot;prefix&quot;, and &quot;suffix&quot;.</span>
    <span class="n">lhs_var_dict</span> <span class="o">=</span> <span class="n">get_variable_name_elements</span><span class="p">(</span><span class="n">lhs_var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">## Now that we have the info about the LHS variable, let&#39;s also find out the &quot;glue&quot; string that needs to be</span>
    <span class="c1">## inserted between all of the loop elements.</span>
    <span class="n">lhs_glue</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">[</span><span class="n">lhs_span</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>

    <span class="c1">## In the string to the right of the ellipsis, look for the template variable farthest to the right.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;.*?&gt;&#39;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 030c: the template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed. It does not have a &#39;</span> <span class="o">+</span> \
              <span class="s1">&#39;template variable to the right of the ellipsis (implied loop).&#39;</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">rhs_span</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
    <span class="n">rhs_var</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="n">rhs_var_dict</span> <span class="o">=</span> <span class="n">get_variable_name_elements</span><span class="p">(</span><span class="n">rhs_var</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rhs_var_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rhs_var_dict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">])</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">rhs_var_dict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Warning 030d: the template string &quot;&#39;</span> <span class="o">+</span> <span class="n">templatestr</span> <span class="o">+</span> <span class="s1">&#39;&quot; is malformed. The LHS variable &quot;&#39;</span> <span class="o">+</span> \
              <span class="n">lhs_var</span> <span class="o">+</span> <span class="s1">&#39;&quot; is not the same as the RHS variable &quot;&#39;</span> <span class="o">+</span> <span class="n">rhs_var</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span>
        <span class="n">bib_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1">## Get the RHS &quot;glue&quot; element. If it has curly braces in it, then we differentiate the conditions between when</span>
    <span class="c1">## the number of names is only two (then use only the stuff inside the curly braces) and more than two (then</span>
    <span class="c1">## use all of the glue). In both cases, remove the first and last curly braces before applying the glue.</span>
    <span class="n">rhs_glue</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">rhs_span</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{.*?\}&#39;</span><span class="p">,</span> <span class="n">rhs_glue</span><span class="p">):</span>
        <span class="n">glue_start</span> <span class="o">=</span> <span class="n">rhs_glue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span>
        <span class="n">glue_end</span> <span class="o">=</span> <span class="n">rhs_glue</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="n">last_glue_if_only_two</span> <span class="o">=</span> <span class="n">rhs_glue</span><span class="p">[</span><span class="n">glue_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">glue_end</span><span class="p">]</span>
        <span class="n">last_glue</span> <span class="o">=</span> <span class="n">rhs_glue</span><span class="p">[:</span><span class="n">glue_start</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhs_glue</span><span class="p">[</span><span class="n">glue_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">glue_end</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhs_glue</span><span class="p">[</span><span class="n">glue_end</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">last_glue_if_only_two</span> <span class="o">=</span> <span class="n">rhs_glue</span>
        <span class="n">last_glue</span> <span class="o">=</span> <span class="n">rhs_glue</span>

    <span class="c1">## Get the part of the template that goes after the implicit loop.</span>
    <span class="n">after_loop_stuff</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">[</span><span class="n">rhs_span</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>

    <span class="n">loop_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;varname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;start_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;end_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_var_dict</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;glue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lhs_glue</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;var_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;var_suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lhs_var_dict</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;last_glue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_glue</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;last_glue_if_only_two&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_glue_if_only_two</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;before_loop_stuff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">before_loop_stuff</span>
    <span class="n">loop_data</span><span class="p">[</span><span class="s1">&#39;after_loop_stuff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">after_loop_stuff</span>

    <span class="k">return</span><span class="p">(</span><span class="n">loop_data</span><span class="p">)</span></div>

<span class="c1">## =============================</span>
<span class="k">def</span> <span class="nf">to_int_or_locale</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
       <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">strxfrm</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="c1">## =============================</span>
<span class="k">def</span> <span class="nf">natural_keys</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    If the sortkeys all begin with numbers, then sort numerically (i.e. -100 before -99, 99 before 100, 10 after 2, etc).</span>
<span class="sd">    http://nedbatchelder.com/blog/200712/human_sorting.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_int_or_locale</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(-?\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

<span class="c1">## ==================================================================================================</span>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sys.argv=&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">uselocale</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;locale=&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">GetoptError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1">## Print help information and exit.</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>              <span class="c1">## this will print something like &quot;option -a not recognized&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bibulous can be called with&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    bibulous.py --locale=mylocale myfile.aux&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;where &quot;locale&quot; is an optional variable.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;--locale&#39;</span><span class="p">):</span>
                <span class="n">uselocale</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;unhandled option&quot;</span>

        <span class="n">arg_auxfile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">arg_auxfile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">## Use the test example input.</span>
        <span class="n">arg_bibfile</span> <span class="o">=</span> <span class="s1">&#39;./test/test1.bib&#39;</span>
        <span class="n">arg_auxfile</span> <span class="o">=</span> <span class="s1">&#39;./test/test1.aux&#39;</span>
        <span class="n">arg_bstfile</span> <span class="o">=</span> <span class="s1">&#39;./test/test1.bst&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg_bibfile</span><span class="p">,</span> <span class="n">arg_auxfile</span><span class="p">,</span> <span class="n">arg_bstfile</span><span class="p">]</span>

    <span class="n">main_bibdata</span> <span class="o">=</span> <span class="n">Bibdata</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">uselocale</span><span class="o">=</span><span class="n">uselocale</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">## Check if the bibliography database and style template files exist. If they don&#39;t, then the user didn&#39;t specify</span>
    <span class="c1">## them, and it&#39;s probably true that there is no bibliography requested. That is, Bibulous was called without any</span>
    <span class="c1">## need.</span>
    <span class="k">if</span> <span class="n">main_bibdata</span><span class="o">.</span><span class="n">filedict</span> <span class="ow">and</span> <span class="n">main_bibdata</span><span class="o">.</span><span class="n">citedict</span><span class="p">:</span>
        <span class="n">main_bibdata</span><span class="o">.</span><span class="n">write_bblfile</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing to BBL file = &#39;</span> <span class="o">+</span> <span class="n">main_bibdata</span><span class="o">.</span><span class="n">filedict</span><span class="p">[</span><span class="s1">&#39;bbl&#39;</span><span class="p">])</span>
        <span class="c1">#os.system(&#39;kwrite &#39; + main_bibdata.filedict[&#39;bbl&#39;])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013, Bibulous developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.
    </div>
  </body>
</html>